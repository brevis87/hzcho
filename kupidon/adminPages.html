<style>
#game {
    margin: 0;
    padding: 20px;
    box-sizing: border-box;
}

:root {
    --crosshair-x: 50%;
    --crosshair-y: 50%;
    --dark900: 12 12 12;
    --light100: 215 215 208;
    --text900: 25 25 25;
    --primary400: 99 65 51;
    --secondary400: 172 172 163;
    --success: 52 199 89;
    --warning: 255 204 0;
    --danger: 236 34 31;
    --font: arial, tahoma, sans-serif;
    --color-accent: #9e654c;
}

#game {
    background: rgb(var(--light100));
    min-height: 100vh;
    position: relative;
    font-family: var(--font);
    display: flex;
    flex-direction: column;
}

.game-header_kup {
    background: rgba(var(--dark900), 0.95);
    padding: 12px 16px;
    border-radius: 4px;
    margin: 20px 20px 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    border: 1px solid rgb(var(--primary400));
}

.game-header_kup .game-title_kup {
    color: rgb(var(--primary400));
    font-size: 20px;
    margin: 0;
    font-weight: bold;
}

.stats_kup {
    display: flex;
    gap: 24px;
}

.stat_kup {
    font-size: 14px;
    color: rgb(var(--primary400));
    font-weight: bold;
}

.stat_kup span {
    color: rgb(var(--primary400));
    font-size: 18px;
}

.controls_kup {
    background: rgba(var(--light100), 0.95);
    padding: 12px 16px;
    border-radius: 4px;
    margin: 0 20px 16px 20px;
    display: flex;
    gap: 12px;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    border: 1px solid rgb(var(--secondary400));
}

.control-btn_kup {
    padding: 10px 20px;
    font-size: 14px;
    background: linear-gradient(45deg, rgb(var(--primary400)), var(--color-accent));
    color: rgb(var(--light100));
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
}

.control-btn_kup:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 3px 10px rgba(var(--primary400), 0.4);
}

.control-btn_kup:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.instructions_kup {
    margin-left: auto;
    color: rgb(var(--secondary400));
    font-size: 12px;
}

/* ============= –°–¢–ê–¢–ò–°–¢–ò–ö–ê –í–°–ï–ì–î–ê –°–ù–ò–ó–£ ============= */
.game-area_kup {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin: 0 20px 20px 20px;
    flex: 1;
}

.game-container_kup {
    position: relative;
    width: 100%;
    height: 60vh;
    min-height: 500px;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    border: 2px solid rgb(var(--primary400));
}

#users {
    width: 100%;
    height: 100%;
    position: relative;
    background: rgb(94, 72, 125);
}

.avatar_kup {
    position: absolute;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: 2px solid rgb(var(--light100));
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    transform: translate3d(0, 0, 0);
    transition: border-color 0.2s;
    z-index: 2;
    will-change: transform;
}

.avatar_kup.fallback_kup {
    background: linear-gradient(45deg, var(--color-accent), rgb(var(--primary400)));
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgb(var(--light100));
    font-weight: bold;
    font-size: 16px;
}

.avatar_kup.paired_kup {
    border: 3px solid var(--color-accent);
    box-shadow: 0 0 15px rgba(158, 101, 76, 0.8);
}

.avatar_kup.highlighted_kup {
    border: 4px solid rgb(var(--danger));
    box-shadow: 0 0 20px rgba(var(--danger), 1);
    transform: scale(1.1);
    z-index: 3;
}

.aim-overlay_kup {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 900;
    opacity: 1;
    background: radial-gradient(
        circle 60px at var(--crosshair-x) var(--crosshair-y),
        transparent 60px,
        rgba(0, 0, 0, 0.95) 100px
    );
}

.target-indicator_kup {
    position: absolute;
    top: 12px;
    right: 12px;
    color: rgb(var(--light100));
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 14px;
    z-index: 1002;
    display: none;
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid rgb(var(--danger));
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
}

.target-indicator_kup .target-name_kup {
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    white-space: nowrap;
}

.target-indicator_kup.free-target_kup {
    border-color: rgb(var(--primary400));
}

.target-indicator_kup.paired-target_kup {
    border-color: var(--color-accent);
}

.crosshair_kup {
    position: absolute;
    width: 40px;
    height: 40px;
    border: 3px solid rgb(var(--danger));
    border-radius: 50%;
    pointer-events: none;
    opacity: 1;
    transform: translate(-50%, -50%);
    z-index: 1001;
    background: rgba(var(--danger), 0.1);
    box-shadow: 
        0 0 20px rgba(var(--danger), 0.8),
        inset 0 0 10px rgba(var(--danger), 0.3);
}

.crosshair_kup::before,
.crosshair_kup::after {
    content: '';
    position: absolute;
    background: rgb(var(--danger));
    box-shadow: 0 0 8px rgba(var(--danger), 0.8);
}

.crosshair_kup::before {
    width: 2px;
    height: 60px;
    top: -60px;
    left: 50%;
    transform: translateX(-50%);
}

.crosshair_kup::after {
    width: 60px;
    height: 2px;
    left: -60px;
    top: 50%;
    transform: translateY(-50%);
}

.crosshair-line-bottom_kup,
.crosshair-line-right_kup {
    position: absolute;
    background: rgb(var(--danger));
    box-shadow: 0 0 8px rgba(var(--danger), 0.8);
}

.crosshair-line-bottom_kup {
    width: 2px;
    height: 60px;
    bottom: -60px;
    left: 50%;
    transform: translateX(-50%);
}

.crosshair-line-right_kup {
    width: 60px;
    height: 2px;
    right: -60px;
    top: 50%;
    transform: translateY(-50%);
}

.shot-effect_kup {
    position: absolute;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(var(--danger), 0.8) 0%, rgba(var(--danger), 0) 70%);
    pointer-events: none;
    opacity: 0;
    transform: translate(-50%, -50%);
    z-index: 1002;
}

/* ============= –ü–ê–ù–ï–õ–¨ –ò–ù–§–û–†–ú–ê–¶–ò–ò –í–°–ï–ì–î–ê –°–ù–ò–ó–£ ============= */
.info-panel_kup {
    width: 100%;
    background: rgba(var(--light100), 0.95);
    border-radius: 4px;
    padding: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: flex;
    gap: 24px;
    border: 1px solid rgb(var(--secondary400));
    flex-shrink: 0;
    height: 200px;
}

.info-left_kup {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.info-right_kup {
    flex: 2;
    display: flex;
    flex-direction: column;
}

.info-panel_kup .panel-title_kup {
    color: rgb(var(--primary400));
    font-size: 14px;
    margin-bottom: 8px;
    border-bottom: 2px solid rgb(var(--primary400));
    padding-bottom: 4px;
    font-weight: bold;
}

.selected-targets_kup .target_kup {
    margin: 6px 0;
    padding: 8px;
    background: rgba(var(--primary400), 0.1);
    border-radius: 4px;
    font-size: 13px;
    border: 1px solid rgba(var(--primary400), 0.3);
}

.target-name_kup {
    font-weight: bold;
    color: rgb(var(--primary400));
}

.pairs-list-content_kup {
    flex: 1;
    overflow-y: auto;
    padding-right: 4px;
    border: 1px solid rgba(var(--secondary400), 0.3);
    border-radius: 4px;
    background: rgba(var(--light100), 0.8);
    height: 120px;
}

.pairs-list-content_kup::-webkit-scrollbar {
    width: 6px;
}

.pairs-list-content_kup::-webkit-scrollbar-track {
    background: rgba(var(--secondary400), 0.1);
    border-radius: 3px;
}

.pairs-list-content_kup::-webkit-scrollbar-thumb {
    background: var(--color-accent);
    border-radius: 3px;
}

.pair-item_kup {
    display: flex;
    align-items: center;
    margin: 4px 0;
    padding: 6px;
    background: rgba(var(--primary400), 0.05);
    border-radius: 4px;
    border-left: 2px solid var(--color-accent);
    font-size: 11px;
    min-height: 32px;
}

.pair-names_kup {
    color: rgb(var(--text900));
    font-weight: bold;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* ============= –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ============= */
.modal-overlay_kup {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(var(--dark900), 0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    flex-direction: column;
    gap: 20px;
}

.modal-content_kup {
    background: rgb(var(--light100));
    padding: 32px;
    border-radius: 4px;
    text-align: center;
    max-width: 400px;
    border: 2px solid rgb(var(--primary400));
}

.modal-content_kup .modal-title_kup {
    color: rgb(var(--primary400));
    margin-bottom: 16px;
    font-size: 24px;
    font-weight: bold;
}

.modal-content_kup p {
    margin: 8px 0;
    font-size: 14px;
    color: rgb(var(--text900));
}

.modal-content_kup ul {
    text-align: left;
    margin: 12px 0;
    padding-left: 20px;
    color: rgb(var(--text900));
    font-size: 14px;
}

.modal-content_kup li {
    margin: 6px 0;
}

.modal-btn_kup {
    margin-top: 16px;
    padding: 12px 24px;
    font-size: 14px;
    background: linear-gradient(45deg, rgb(var(--primary400)), var(--color-accent));
    color: rgb(var(--light100));
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
}

.modal-btn_kup:hover {
    transform: scale(1.05);
    box-shadow: 0 3px 12px rgba(var(--primary400), 0.4);
}

.modal-btn-secondary_kup {
    margin-top: 8px;
    padding: 8px 16px;
    font-size: 12px;
    background: transparent;
    color: rgb(var(--primary400));
    border: 1px solid rgb(var(--primary400));
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
}

.modal-btn-secondary_kup:hover {
    background: rgba(var(--primary400), 0.1);
}

.score-animation_kup {
    position: absolute;
    color: rgb(var(--danger));
    font-size: 20px;
    font-weight: bold;
    text-shadow: 
        0 0 10px rgba(var(--danger), 0.8),
        2px 2px 4px rgba(0,0,0,0.3);
    pointer-events: none;
    z-index: 1004;
    animation: floatUp 1.2s ease-out forwards;
}

@keyframes floatUp {
    0% {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
    100% {
        transform: translateY(-60px) scale(1.3);
        opacity: 0;
    }
}

#loadingScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(var(--dark900), 0.95);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    color: rgb(var(--light100));
}

#loadingBar {
    width: 0%;
    height: 100%;
    background: linear-gradient(45deg, rgb(var(--primary400)), var(--color-accent));
    transition: width 0.3s;
}

/* ============= –ö–ù–û–ü–ö–ò –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• ============= */
.mobile-controls_kup {
    display: none;
    justify-content: space-between;
    align-items: flex-end;
    gap: 15px;
    margin-top: 5px;
    padding: 5px;
}

/* –†–û–ú–ë–ò–ö - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π */
.mobile-arrows_kup {
    display: flex;
    align-items: center;
    gap: 0;
    position: relative;
}

.arrow-row-top_kup {
    display: flex;
    justify-content: center;
    margin-bottom: -8px;
}

.arrow-row-middle_kup {
    display: flex;
    justify-content: space-between;
    width: 100%;
    gap: 40px;
}

.arrow-row-bottom_kup {
    display: flex;
    justify-content: center;
    margin-top: -8px;
}

.arrow-btn_kup {
    width: 60px;
    height: 60px;
    font-size: 28px;
    background: rgba(99,65,51,0.9);
    color: white;
    border: none;
    border-radius: 16px;
    cursor: pointer;
    box-shadow: 0 4px 0 rgba(0,0,0,0.2);
    transition: all 0.05s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.arrow-btn_kup:active {
    transform: translateY(4px);
    box-shadow: 0 1px 0 rgba(0,0,0,0.2);
}

.shoot-btn_kup {
    width: 90px;
    height: 90px;
    font-size: 48px;
    background: rgb(236,34,31);
    color: white;
    border: none;
    border-radius: 45px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 6px 0 rgba(0,0,0,0.2);
    transition: all 0.05s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.shoot-btn_kup:active {
    transform: translateY(6px);
    box-shadow: 0 1px 0 rgba(0,0,0,0.2);
}


@media (max-width: 768px) {
    .mobile-controls_kup {
        display: flex;
    }
}
</style>

<div id="game_kup">
    <div class="game-header_kup">
        <div class="game-title_kup">–ü–¨–Ø–ù–´–ô –ö–£–ü–ò–î–û–ù</div>
        <div class="stats_kup">
            <div class="stat_kup">–ü–∞—Ä—ã: <span id="pairsCount">0</span></div>
            <div class="stat_kup">–û—á–∫–∏: <span id="score">0</span></div>
            <div class="stat_kup">–¶–µ–ª–∏: <span id="shotsCount">0/2</span></div>
        </div>
    </div>
    
    <div class="controls_kup">
        <button id="startBtn" class="control-btn_kup">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É</button>
        <button id="rulesBtn" class="control-btn_kup">–ü—Ä–∞–≤–∏–ª–∞</button>
        <button id="endGameBtn" class="control-btn_kup end-game-btn_kup">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
        <div class="instructions_kup">
            <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> WASD - –ø—Ä–∏—Ü–µ–ª, Space - –≤—ã—Å—Ç—Ä–µ–ª
        </div>
    </div>
    
    <div class="game-area_kup">
        <div class="game-container_kup">
            <div class="aim-overlay_kup" id="aimOverlay"></div>
            <div id="users"></div>
            <div class="target-indicator_kup" id="targetIndicator">
                <div class="target-name_kup" id="currentTargetName"></div>
            </div>
            <div class="crosshair_kup" id="crosshair">
                <div class="crosshair-line-bottom_kup"></div>
                <div class="crosshair-line-right_kup"></div>
            </div>
            <div class="shot-effect_kup"></div>
            
            <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–†–ê–í–ò–õ -->
            <div class="modal-overlay_kup" id="rulesModal">
                <div class="modal-content_kup">
                    <div class="modal-title_kup">–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</div>
                    <div class="modal-title_kup">–¢—ã - –ü–¨–Ø–ù–´–ô –ö–£–ü–ò–î–û–ù.</div>
                    <ul>
                        <li>üéØ –ù–∞–≤–æ–¥–∏ –ø—Ä–∏—Ü–µ–ª –Ω–∞ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏ –ø–∞–ª–∏!</li>
                        <li>üíò –î–≤–∞ –≤—ã—Å—Ç—Ä–µ–ª–∞ —Å–æ–∑–¥–∞—é—Ç –ø–∞—Ä—É</li>
                        <li>‚ù§Ô∏è –ù–µ —Å—Ç—Ä–µ–ª—è–π –≤ —É–∂–µ –ø–æ–¥–±–∏—Ç—ã—Ö ‚Äî –∏–≥—Ä–∞ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è</li>
                        <li>üèÜ –°–æ–∑–¥–∞–π –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –ø–∞—Ä</li>
                        <li>‚≠ê –ó–∞ –≤—ã—Å—Ç—Ä–µ–ª + 1 –æ—á–∫–æ, –∑–∞ –ø–∞—Ä—É + 1 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ—á–∫–æ</li>
                        <li>üì± –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ —É–ø—Ä–∞–≤–ª—è–π —Å—Ç—Ä–µ–ª–∫–∞–º–∏ –∏ –∫–Ω–æ–ø–∫–æ–π (–ø–æ–¥ –∏–≥—Ä–æ–≤—ã–º –ø–æ–ª–µ–º)</li>
                        <li>‚ùó –ò–≥—Ä–∞ –ó–ê–í–ï–†–®–ò–¢–°–Ø –ª–∏–±–æ –ø–æ—Å–ª–µ –ø–æ–±–µ–¥—ã, –ª–∏–±–æ –ø–æ—Å–ª–µ –ø–æ—Ä–∞–∂–µ–Ω–∏—è, –ª–∏–±–æ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –°–ü–ï–¶–ò–ê–õ–¨–ù–û–ô –∫–Ω–æ–ø–∫–∏. –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ù–ï –°–û–•–†–ê–ù–Ø–Æ–¢–°–Ø.</li>
                    </ul>
                    <button id="closeRulesBtn" class="modal-btn_kup">–ü–æ–Ω—è—Ç–Ω–æ!</button>
                </div>
            </div>
            
            <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ö–û–ù–¶–ê –ò–ì–†–´ -->
            <div class="modal-overlay_kup" id="gameOverlay">
                <div class="modal-content_kup">
                    <div class="modal-title_kup" id="overlayTitle">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</div>
                    <p id="overlayReason">–í—ã –ø–æ–ø–∞–ª–∏ –≤ —É–∂–µ –∑–∞–Ω—è—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞</p>
                    <p>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span id="overlayScore">0</span> –æ—á–∫–æ–≤</p>
                    <p>–°–æ–∑–¥–∞–Ω–æ –ø–∞—Ä: <span id="overlayPairs">0</span></p>
                    <button id="restartGameBtn" class="modal-btn_kup">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
                    <button id="continueBtn" class="modal-btn-secondary_kup">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä</button>
                </div>
            </div>
        </div>
        
        <!-- –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø –¢–ï–õ–ï–§–û–ù–ê - –†–û–ú–ë–ò–ö–û–ú, –ë–ï–ó –≠–ú–û–î–ó–ò, –ö–û–ú–ü–ê–ö–¢–ù–û -->
        <div class="mobile-controls_kup">
            <div class="mobile-arrows_kup">
                <div class="arrow-row-top_kup">
                    <button id="arrowUp" class="arrow-btn_kup">‚ñ≤</button>
                </div>
                <div class="arrow-row-middle">
                    <button id="arrowLeft" class="arrow-btn_kup">‚óÄ</button>
                    <button id="arrowRight" class="arrow-btn_kup">‚ñ∂</button>
                </div>
                <div class="arrow-row-bottom">
                    <button id="arrowDown" class="arrow-btn_kup">‚ñº</button>
                </div>
            </div>
            <div class="mobile-shoot_kup">
                <button id="shootBtn" class="shoot-btn_kup">üéØ</button>
            </div>
        </div>
        
        <div class="info-panel_kup">
            <div class="info-left_kup">
                <div class="selected-targets_kup">
                    <div class="panel-title_kup">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ü–µ–ª–∏:</div>
                    <div id="target1" class="target_kup">1. <span class="target-name_kup">-</span></div>
                    <div id="target2" class="target_kup">2. <span class="target-name_kup">-</span></div>
                </div>
            </div>
            
            <div class="info-right_kup">
                <div class="pairs-list_kup">
                    <div class="panel-title_kup">–°–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—ã: <span id="pairsCountSmall">0</span></div>
                    <div id="pairsList" class="pairs-list-content_kup"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
var mainUrl = "https://pulseofny.rusff.me";
var users = [];
const userDiv = $("#users");
const startBtn = $("#startBtn");
const statsBtn = $("#statsBtn");
const rulesBtn = $("#rulesBtn");
const endGameBtn = $("#endGameBtn");

// –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
const crosshair = $(".crosshair_kup");
const aimOverlay = $("#aimOverlay");
const shotEffect = $(".shot-effect_kup");
const gameOverlay = $("#gameOverlay");
const rulesModal = $("#rulesModal");
const closeRulesBtn = $("#closeRulesBtn");
const overlayTitle = $("#overlayTitle");
const overlayReason = $("#overlayReason");
const overlayScore = $("#overlayScore");
const overlayPairs = $("#overlayPairs");
const restartGameBtn = $("#restartGameBtn");
const continueBtn = $("#continueBtn");

const pairsCountEl = $("#pairsCount");
const scoreEl = $("#score");
const shotsCountEl = $("#shotsCount");
const targetIndicator = $("#targetIndicator");
const currentTargetName = $("#currentTargetName");
const target1El = $("#target1 .target-name_kup");
const target2El = $("#target2 .target-name_kup");
const pairsListEl = $("#pairsList");
const pairsCountSmall = $("#pairsCountSmall");

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
let gameState = {
    isRunning: false,
    currentTargets: [null, null],
    pairs: [],
    score: 0,
    shots: 0,
    selectedAvatars: [],
    currentTarget: null,
    highlightedAvatar: null,
    isShooting: false,
    gameEndReason: null,
    gameEndedByAvatar: null
};

// –ü–æ–∑–∏—Ü–∏—è –ø—Ä–∏—Ü–µ–ª–∞
let crosshairPos = {
    x: 0,
    y: 0
};

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∞–≤–∏—à
const keysPressed = {
    w: false,
    s: false,
    a: false,
    d: false,
    '—Ü': false,
    '—ã': false,
    '—Ñ': false,
    '–≤': false
};

// –î–∞–Ω–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä–æ–≤
let avatars = [];

// ============= TIME-BASED –î–í–ò–ñ–ï–ù–ò–ï =============
const BASE_SPEED = 40;
const CROSSHAIR_SPEED = 240;

const config = {
    avatarCount: 500,
    shotPoints: 1,
    pairPoints: 1,
    speedReductionOnBounce: 0.95,
    speedReductionOnPair: 0.4,
    randomChangeChance: 0.15,
    randomChangeAmount: 4
};

// –§–ò–ó–ò–ö–ê –° –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ú –®–ê–ì–û–ú
const PHYSICS_STEP = 1/60;
let physicsAccumulator = 0;
let lastTimestamp = 0;
let animationFrameId = null;

// ==============================================

let loadedAvatars = 0;
let totalAvatars = 0;
let loadingScreen = null;

// –†–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
let containerWidth = 800;
let containerHeight = 600;
let containerInitialized = false;

function updateContainerSize() {
    if (userDiv.length) {
        const newWidth = userDiv.width();
        const newHeight = userDiv.height();
        if (newWidth && newHeight) {
            containerWidth = newWidth;
            containerHeight = newHeight;
            containerInitialized = true;
        }
    }
}

// ============= –°–¢–ê–¢–ò–°–¢–ò–ö–ê - –¢–û–õ–¨–ö–û –í –ö–û–ù–¶–ï –ò–ì–†–´ =============

const APP_ID = 16777213;
const STORAGE_KEY = 'cupid_stats';
const RULES_SEEN_KEY = 'cupid_rules_seen';

// –¢–ï–ö–£–©–ê–Ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —ç—Ç–æ–π –∏–≥—Ä—ã (–Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è)
let currentGameStats = {
    targets: [],      // ID –∞–≤–∞—Ç–∞—Ä–æ–≤, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Å—Ç—Ä–µ–ª—è–ª–∏
    pairs: [],        // –û–±—ä–µ–∫—Ç—ã { a1: id1, a2: id2 }
    finalAvatar: null // ID —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞ (–µ—Å–ª–∏ –ø—Ä–æ–∏–≥—Ä–∞–ª–∏)
};

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è)
let serverStats = null;

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å —Å–µ—Ä–≤–µ—Ä–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
async function fetchFreshStats(retries = 3) {
    for (let attempt = 0; attempt < retries; attempt++) {
        try {
            const response = await $.get("/api.php", {
                token: ForumAPITicket,
                method: "storage.get",
                app_id: APP_ID,
                key: [STORAGE_KEY]
            });
            
            if (response.response && response.response.storage.data[STORAGE_KEY]) {
                return JSON.parse(response.response.storage.data[STORAGE_KEY]);
            }
        } catch (e) {
            console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–ø–æ–ø—ã—Ç–∫–∞ ${attempt + 1}/${retries}):`, e);
            
            if (attempt === retries - 1) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É');
            }
            
            await new Promise(r => setTimeout(r, 500 * Math.pow(2, attempt)));
        }
    }
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
    return {
        totalGames: 0,
        totalScore: 0,
        players: {},
        pairs: {},
        targets: {},
        finals: {}
    };
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
async function loadStats() {
    try {
        serverStats = await fetchFreshStats();
    } catch (e) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', e);
        serverStats = {
            totalGames: 0,
            totalScore: 0,
            players: {},
            pairs: {},
            targets: {},
            finals: {}
        };
    }
    return serverStats;
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–ø—Ä–∏–±–∞–≤–ª—è–µ–º currentGameStats –∫ serverStats)
async function saveFinalStats(retries = 3) {
    for (let attempt = 0; attempt < retries; attempt++) {
        try {
            // 1. –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
            const freshStats = await fetchFreshStats(1);
            
            // 2. –ü—Ä–∏–±–∞–≤–ª—è–µ–º –∫ –Ω–∏–º —Ç–µ–∫—É—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const playerId = UserID.toString();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
            if (!freshStats.players[playerId]) {
                freshStats.players[playerId] = {
                    games: 0,
                    totalScore: 0,
                    bestScore: 0
                };
            }
            freshStats.players[playerId].games++;
            freshStats.players[playerId].totalScore += gameState.score;
            freshStats.players[playerId].bestScore = Math.max(
                freshStats.players[playerId].bestScore || 0,
                gameState.score
            );
            
            // –û–±—â–∏–µ —Å—á—ë—Ç—á–∏–∫–∏
            freshStats.totalGames = (freshStats.totalGames || 0) + 1;
            freshStats.totalScore = (freshStats.totalScore || 0) + gameState.score;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏—è
            if (!freshStats.targets) freshStats.targets = {};
            for (const avatarId of currentGameStats.targets) {
                const realId = avatars[avatarId].user.user_id.toString();
                freshStats.targets[realId] = (freshStats.targets[realId] || 0) + 1;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä—ã
            if (!freshStats.pairs) freshStats.pairs = {};
            for (const pair of currentGameStats.pairs) {
                const id1 = avatars[pair.a1].user.user_id.toString();
                const id2 = avatars[pair.a2].user.user_id.toString();
                const pairKey = [id1, id2].sort((a, b) => parseInt(a) - parseInt(b)).join('-');
                freshStats.pairs[pairKey] = (freshStats.pairs[pairKey] || 0) + 1;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞
            if (currentGameStats.finalAvatar !== null) {
                if (!freshStats.finals) freshStats.finals = {};
                const realId = avatars[currentGameStats.finalAvatar].user.user_id.toString();
                freshStats.finals[realId] = (freshStats.finals[realId] || 0) + 1;
            }
            
            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º
            await $.post("/api.php", {
                token: ForumAPITicket,
                method: "storage.set",
                app_id: APP_ID,
                key: STORAGE_KEY,
                value: JSON.stringify(freshStats)
            });
            
            // 4. –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
            serverStats = freshStats;
            
            console.log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
            return true;
            
        } catch (e) {
            console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–ø–æ–ø—ã—Ç–∫–∞ ${attempt + 1}/${retries}):`, e);
            
            if (attempt < retries - 1) {
                await new Promise(r => setTimeout(r, 500 * Math.pow(2, attempt)));
            }
        }
    }
    
    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É');
    
    // –ë—ç–∫–∞–ø
    try {
        const backupKey = 'cupid_stats_backup_' + Date.now();
        localStorage.setItem(backupKey, JSON.stringify({
            timestamp: Date.now(),
            playerId: UserID,
            gameScore: gameState.score,
            currentGameStats: currentGameStats
        }));
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –Ω–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ');
    } catch (e) {}
    
    return false;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ (–æ–¥–∏–Ω —Ä–∞–∑)
async function initAvatarsInStats() {
    try {
        const freshStats = await fetchFreshStats();
        
        if (!freshStats.targets) freshStats.targets = {};
        if (!freshStats.finals) freshStats.finals = {};
        
        for (let i = 0; i < avatars.length; i++) {
            const realId = avatars[i].user.user_id.toString();
            if (!freshStats.targets[realId]) {
                freshStats.targets[realId] = 0;
            }
            if (!freshStats.finals[realId]) {
                freshStats.finals[realId] = 0;
            }
        }
        
        await $.post("/api.php", {
            token: ForumAPITicket,
            method: "storage.set",
            app_id: APP_ID,
            key: STORAGE_KEY,
            value: JSON.stringify(freshStats)
        });
        
        serverStats = freshStats;
    } catch (e) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', e);
    }
}

// ============= –ö–õ–ê–°–° –ê–í–ê–¢–ê–†–ê =============
class Avatar {
    constructor(user, index) {
        this.id = index;
        this.user = user;
        
        if (!containerInitialized) {
            updateContainerSize();
        }
        
        this.size = 45;
        this.x = Math.random() * (containerWidth - this.size) + this.size/2;
        this.y = Math.random() * (containerHeight - this.size) + this.size/2;
        
        const angle = Math.random() * Math.PI * 2;
        this.vx = Math.cos(angle) * BASE_SPEED;
        this.vy = Math.sin(angle) * BASE_SPEED;
        
        this.isPaired = false;
        this.pairId = null;
        this.element = null;
        this.isLoaded = false;
        this.isHighlighted = false;
        
        this.createElement();
    }
    
    createElement() {
        const div = document.createElement('div');
        div.className = 'avatar_kup';
        div.dataset.id = this.id;
        div.title = this.user.username;
        
        div.style.width = this.size + 'px';
        div.style.height = this.size + 'px';
        
        totalAvatars++;
        updateLoadingProgress();
        
        const img = new Image();
        img.onload = () => {
            div.style.backgroundImage = `url(${img.src})`;
            this.isLoaded = true;
            loadedAvatars++;
            updateLoadingProgress();
        };
        
        img.onerror = () => {
            div.classList.add('fallback_kup');
            div.textContent = this.user.username.charAt(0).toUpperCase();
            this.isLoaded = true;
            loadedAvatars++;
            updateLoadingProgress();
        };
        
        img.src = mainUrl + this.user.avatar;
        userDiv.append(div);
        this.element = div;
    }
    
    updatePosition(deltaTime) {
        if (!this.isLoaded || !gameState.isRunning) return;
        
        this.x += this.vx * deltaTime;
        this.y += this.vy * deltaTime;
        
        const halfSize = this.size / 2;
        
        if (this.x < halfSize) {
            this.vx = Math.abs(this.vx) * config.speedReductionOnBounce;
            this.x = halfSize;
        } else if (this.x > containerWidth - halfSize) {
            this.vx = -Math.abs(this.vx) * config.speedReductionOnBounce;
            this.x = containerWidth - halfSize;
        }
        
        if (this.y < halfSize) {
            this.vy = Math.abs(this.vy) * config.speedReductionOnBounce;
            this.y = halfSize;
        } else if (this.y > containerHeight - halfSize) {
            this.vy = -Math.abs(this.vy) * config.speedReductionOnBounce;
            this.y = containerHeight - halfSize;
        }
        
        if (Math.random() < 0.005) {
            this.vx += (Math.random() - 0.5) * 4;
            this.vy += (Math.random() - 0.5) * 4;
            
            const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
            const maxSpeed = this.isPaired ? BASE_SPEED * 0.6 : BASE_SPEED * 1.3;
            if (speed > maxSpeed) {
                this.vx = (this.vx / speed) * maxSpeed;
                this.vy = (this.vy / speed) * maxSpeed;
            }
        }
        
        if (this.element) {
            this.element.style.transform = `translate3d(${Math.round(this.x - halfSize)}px, ${Math.round(this.y - halfSize)}px, 0)`;
        }
    }
    
    checkCrosshairHit(cx, cy) {
        const dx = this.x - cx;
        const dy = this.y - cy;
        return (dx * dx + dy * dy) < (this.size/2) * (this.size/2);
    }
    
    markAsPaired(pairId) {
        this.isPaired = true;
        this.pairId = pairId;
        if (this.element) {
            this.element.classList.add('paired_kup');
        }
        this.vx *= config.speedReductionOnPair;
        this.vy *= config.speedReductionOnPair;
    }
    
    highlight() {
        if (this.element && !this.isHighlighted) {
            this.element.classList.add('highlighted_kup');
            this.isHighlighted = true;
        }
    }
    
    unhighlight() {
        if (this.element && this.isHighlighted) {
            this.element.classList.remove('highlighted_kup');
            this.isHighlighted = false;
        }
    }
    
    reset() {
        if (this.element && this.element.parentNode) {
            this.element.parentNode.removeChild(this.element);
        }
        this.element = null;
        this.isLoaded = false;
    }
}

// ============= –ó–ê–ì–†–£–ó–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô =============
async function loadUsers() {
    return new Promise((resolve) => {
        const url = new URL(mainUrl + "/api.php");
        url.searchParams.append("method", "users.get");
        url.searchParams.append("limit", config.avatarCount);
        url.searchParams.append("group_id", [1,2,6]);
        url.searchParams.append("fields", ["user_id", "username", "avatar"]);
        
        $.ajax({
            url: url.href,
            method: 'post',
            dataType: 'json',
            success: function(data) {
                if (data.response?.users) {
                    users = data.response.users.slice(0, config.avatarCount);
                }
                resolve();
            },
            error: function() {
                users = Array.from({length: config.avatarCount}, (_, i) => ({
                    user_id: 1000 + i,
                    username: `User${i + 1}`,
                    avatar: '/images/avatar.png'
                }));
                resolve();
            }
        });
    });
}

async function createAvatars() {
    userDiv.empty();
    avatars.forEach(a => a.reset());
    avatars = [];
    loadedAvatars = 0;
    totalAvatars = 0;
    
    for (let i = 0; i < Math.min(users.length, config.avatarCount); i++) {
        avatars.push(new Avatar(users[i], i));
    }
}

function waitForAvatarsToLoad() {
    return new Promise((resolve) => {
        const check = setInterval(() => {
            if (loadedAvatars >= totalAvatars && totalAvatars > 0) {
                clearInterval(check);
                resolve();
            }
        }, 50);
    });
}

// ============= –§–ò–ó–ò–ö–ê =============
function updatePhysics(deltaTime) {
    for (let i = 0; i < avatars.length; i++) {
        avatars[i].updatePosition(deltaTime);
    }
}

function updateCrosshairPosition(deltaTime) {
    let dx = 0, dy = 0;
    
    if (keysPressed.w || keysPressed.—Ü) dy -= 1;
    if (keysPressed.s || keysPressed.—ã) dy += 1;
    if (keysPressed.a || keysPressed.—Ñ) dx -= 1;
    if (keysPressed.d || keysPressed.–≤) dx += 1;
    
    if (dx !== 0 && dy !== 0) {
        dx *= 0.7071;
        dy *= 0.7071;
    }
    
    crosshairPos.x += dx * CROSSHAIR_SPEED * deltaTime;
    crosshairPos.y += dy * CROSSHAIR_SPEED * deltaTime;
    
    crosshairPos.x = Math.max(20, Math.min(crosshairPos.x, containerWidth - 20));
    crosshairPos.y = Math.max(20, Math.min(crosshairPos.y, containerHeight - 20));
    
    crosshair.css({
        left: crosshairPos.x + 'px',
        top: crosshairPos.y + 'px'
    });
    
    document.documentElement.style.setProperty('--crosshair-x', crosshairPos.x + 'px');
    document.documentElement.style.setProperty('--crosshair-y', crosshairPos.y + 'px');
}

function checkTargetUnderCrosshair() {
    if (gameState.highlightedAvatar) {
        gameState.highlightedAvatar.unhighlight();
        gameState.highlightedAvatar = null;
    }
    
    let found = null;
    for (let i = 0; i < avatars.length; i++) {
        const a = avatars[i];
        if (!a.isLoaded) continue;
        
        if (a.checkCrosshairHit(crosshairPos.x, crosshairPos.y)) {
            found = a;
            break;
        }
    }
    
    if (found) {
        gameState.currentTarget = found;
        gameState.highlightedAvatar = found;
        found.highlight();
        
        if (found.isPaired) {
            currentTargetName.text(found.user.username);
            targetIndicator.removeClass('free-target_kup').addClass('paired-target_kup');
        } else {
            currentTargetName.text(found.user.username);
            targetIndicator.removeClass('paired-target_kup').addClass('free-target_kup');
        }
        targetIndicator.show();
    } else {
        gameState.currentTarget = null;
        targetIndicator.hide();
    }
}

// ============= –ò–ì–†–û–í–û–ô –¶–ò–ö–õ =============
function gameLoop(currentTime) {
    if (!gameState.isRunning) {
        animationFrameId = requestAnimationFrame(gameLoop);
        return;
    }
    
    if (lastTimestamp === 0) {
        lastTimestamp = currentTime;
        animationFrameId = requestAnimationFrame(gameLoop);
        return;
    }
    
    let deltaTime = (currentTime - lastTimestamp) / 1000;
    lastTimestamp = currentTime;
    
    if (deltaTime > 0.033) deltaTime = 0.033;
    
    if (Math.random() < 0.05) updateContainerSize();
    
    physicsAccumulator += deltaTime;
    
    if (physicsAccumulator >= PHYSICS_STEP) {
        updatePhysics(PHYSICS_STEP);
        physicsAccumulator -= PHYSICS_STEP;
        if (physicsAccumulator > 0.1) physicsAccumulator = 0;
    }
    
    if (!gameState.isShooting) {
        updateCrosshairPosition(deltaTime);
        checkTargetUnderCrosshair();
    }
    
    animationFrameId = requestAnimationFrame(gameLoop);
}

// ============= –£–ü–†–ê–í–õ–ï–ù–ò–ï =============
function initKeyboardControls() {
    $(document).off('keydown').on('keydown', function(e) {
        const key = e.key.toLowerCase();
        
        if (gameState.isShooting) {
            e.preventDefault();
            return;
        }
        
        if (['w','s','a','d','—Ü','—ã','—Ñ','–≤'].includes(key)) {
            keysPressed[key] = true;
            e.preventDefault();
        }
        
        if (e.code === 'Space' || e.key === ' ') {
            e.preventDefault();
            if (gameState.isRunning && !gameState.isShooting && gameState.shots < 2 && gameState.currentTarget) {
                shoot();
            }
        }
    });
    
    $(document).off('keyup').on('keyup', function(e) {
        const key = e.key.toLowerCase();
        if (['w','s','a','d','—Ü','—ã','—Ñ','–≤'].includes(key)) {
            keysPressed[key] = false;
        }
        if (e.code === 'Space' || e.key === ' ') {
            e.preventDefault();
        }
    });
    
    $(window).off('keydown').on('keydown', function(e) {
        if (e.code === 'Space' || e.key === ' ') {
            e.preventDefault();
            return false;
        }
    });
}

// ============= –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê =============
function areAllAvatarsPaired() {
    for (let i = 0; i < avatars.length; i++) {
        if (!avatars[i].isPaired) return false;
    }
    return true;
}

function shoot() {
    if (gameState.isShooting || gameState.shots >= 2 || !gameState.currentTarget) return;
    
    gameState.isShooting = true;
    const hit = gameState.currentTarget;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    currentGameStats.targets.push(hit.id);
    
    if (hit.isPaired) {
        gameState.gameEndReason = 'paired';
        gameState.gameEndedByAvatar = hit;
        currentGameStats.finalAvatar = hit.id;
        setTimeout(() => {
            gameState.isShooting = false;
            endGame();
        }, 50);
        return;
    }
    
    if (gameState.selectedAvatars.includes(hit.id)) {
        gameState.isShooting = false;
        return;
    }
    
    shotEffect.css({
        left: crosshairPos.x + 'px',
        top: crosshairPos.y + 'px',
        opacity: 1
    }).stop().animate({ opacity: 0 }, 200);
    
    gameState.selectedAvatars.push(hit.id);
    gameState.shots++;
    shotsCountEl.text(`${gameState.shots}/2`);
    
    if (gameState.shots === 1) {
        target1El.text(hit.user.username);
        gameState.currentTargets[0] = hit;
    } else {
        target2El.text(hit.user.username);
        gameState.currentTargets[1] = hit;
        createPair();
        
        setTimeout(() => {
            gameState.selectedAvatars = [];
            gameState.shots = 0;
            gameState.currentTargets = [null, null];
            target1El.text("-");
            target2El.text("-");
            shotsCountEl.text("0/2");
            
            if (areAllAvatarsPaired()) {
                gameState.gameEndReason = 'victory';
                endGame();
            }
        }, 800);
    }
    
    addScore(config.shotPoints);
    setTimeout(() => { gameState.isShooting = false; }, 200);
}

function createPair() {
    const [a1, a2] = gameState.currentTargets;
    if (!a1 || !a2) return;
    
    const pairId = gameState.pairs.length;
    a1.markAsPaired(pairId);
    a2.markAsPaired(pairId);
    
    gameState.pairs.push({
        id: pairId,
        avatar1: a1,
        avatar2: a2
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä—É –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    currentGameStats.pairs.push({ a1: a1.id, a2: a2.id });
    
    const item = $(`
        <div class="pair-item_kup">
            <div class="pair-names_kup">${a1.user.username} ‚ù§Ô∏è ${a2.user.username}</div>
        </div>
    `);
    pairsListEl.append(item);
    pairsListEl.scrollTop(pairsListEl[0].scrollHeight);
    
    pairsCountEl.text(gameState.pairs.length);
    pairsCountSmall.text(gameState.pairs.length);
    addScore(config.pairPoints);
}

function addScore(points) {
    gameState.score += points;
    scoreEl.text(gameState.score);
    
    const anim = $(`<div class="score-animation_kup">+${points}</div>`);
    anim.css({ left: crosshairPos.x + 'px', top: crosshairPos.y + 'px' })
        .appendTo(userDiv);
    setTimeout(() => anim.remove(), 1000);
}

// ============= –ö–û–ù–ï–¶ –ò–ì–†–´ =============
async function endGame() {
    gameState.isRunning = false;
    gameState.isShooting = false;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –í–°–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π
    const saved = await saveFinalStats();
    
    if (!saved) {
        console.warn('‚ö†Ô∏è –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
    }
    
    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    currentGameStats = {
        targets: [],
        pairs: [],
        finalAvatar: null
    };
    
    overlayScore.text(gameState.score);
    overlayPairs.text(gameState.pairs.length);
    
    if (gameState.gameEndReason === 'victory') {
        overlayTitle.text('–ü–æ–±–µ–¥–∞!');
        overlayReason.text('–í—ã —Å–æ–µ–¥–∏–Ω–∏–ª–∏ –≤—Å–µ—Ö –∞–≤–∞—Ç–∞—Ä–æ–≤ –≤ –ø–∞—Ä—ã!');
    } else if (gameState.gameEndReason === 'manual') {
        overlayTitle.text('–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        overlayReason.text('–í—ã –¥–æ—Å—Ä–æ—á–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∏–≥—Ä—É');
    } else {
        overlayTitle.text('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!');
        overlayReason.text('–í—ã –ø–æ–ø–∞–ª–∏ –≤ —É–∂–µ –∑–∞–Ω—è—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞');
    }
    
    gameOverlay.fadeIn(200);
}

async function forceEndGame() {
    if (!gameState.isRunning) return;
    
    gameState.isRunning = false;
    gameState.isShooting = false;
    gameState.gameEndReason = 'manual';
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—ë –∫–∞–∫ –≤ –æ–±—ã—á–Ω–æ–º endGame
    const saved = await saveFinalStats();
    
    if (!saved) {
        console.warn('‚ö†Ô∏è –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–æ—Å—Ä–æ—á–Ω–æ, –Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
    }
    
    currentGameStats = {
        targets: [],
        pairs: [],
        finalAvatar: null
    };
    
    overlayScore.text(gameState.score);
    overlayPairs.text(gameState.pairs.length);
    overlayTitle.text('–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    overlayReason.text('–í—ã –¥–æ—Å—Ä–æ—á–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∏–≥—Ä—É');
    
    gameOverlay.fadeIn(200);
}

function restartGame() {
    gameOverlay.fadeOut(200);
    
    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    currentGameStats = {
        targets: [],
        pairs: [],
        finalAvatar: null
    };
    
    loadStats().then(() => {
        startGame();
    }).catch(() => {
        startGame();
    });
}

// ============= –ó–ê–ü–£–°–ö –ò–ì–†–´ =============
async function startGame() {
    gameOverlay.hide();
    
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
    }
    
    gameState = {
        isRunning: false,
        currentTargets: [null, null],
        pairs: [],
        score: 0,
        shots: 0,
        selectedAvatars: [],
        currentTarget: null,
        highlightedAvatar: null,
        isShooting: false,
        gameEndReason: null,
        gameEndedByAvatar: null
    };
    
    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    currentGameStats = {
        targets: [],
        pairs: [],
        finalAvatar: null
    };
    
    for (let key in keysPressed) {
        keysPressed[key] = false;
    }
    
    scoreEl.text("0");
    pairsCountEl.text("0");
    pairsCountSmall.text("0");
    shotsCountEl.text("0/2");
    target1El.text("-");
    target2El.text("-");
    pairsListEl.empty();
    
    createLoadingScreen();
    
    startBtn.prop('disabled', true);
    
    if (users.length === 0) await loadUsers();
    await createAvatars();
    await waitForAvatarsToLoad();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤–∞—Ç–∞—Ä–æ–≤ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ (–æ–¥–∏–Ω —Ä–∞–∑)
    await initAvatarsInStats();
    
    updateContainerSize();
    
    crosshairPos.x = containerWidth / 2;
    crosshairPos.y = containerHeight / 2;
    crosshair.css({ left: crosshairPos.x + 'px', top: crosshairPos.y + 'px' });
    updateCrosshairPosition(0);
    
    lastTimestamp = 0;
    physicsAccumulator = 0;
    
    gameState.isRunning = true;
    startBtn.text("–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫").prop('disabled', false);
    
    animationFrameId = requestAnimationFrame(gameLoop);
}

function createLoadingScreen() {
    loadingScreen = $(`
        <div id="loadingScreen">
            <div style="font-size: 28px; margin-bottom: 24px; color: rgb(var(--primary400)); font-weight: bold;">
                –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–æ–≤...
            </div>
            <div style="width: 300px; height: 16px; background: rgba(var(--light100), 0.2); border-radius: 4px; overflow: hidden;">
                <div id="loadingBar"></div>
            </div>
            <div id="loadingText" style="font-size: 14px; margin-top: 12px;">0%</div>
        </div>
    `);
    $('body').append(loadingScreen);
}

function updateLoadingProgress() {
    const percentage = totalAvatars > 0 ? Math.round((loadedAvatars / totalAvatars) * 100) : 0;
    $('#loadingBar').css('width', percentage + '%');
    $('#loadingText').text(`${percentage}% (${loadedAvatars} –∏–∑ ${totalAvatars})`);
    
    if (loadedAvatars >= totalAvatars && totalAvatars > 0) {
        setTimeout(() => {
            if (loadingScreen) {
                loadingScreen.fadeOut(300, function() { $(this).remove(); });
            }
            startBtn.prop('disabled', false);
        }, 300);
    }
}

// ============= –£–ü–†–ê–í–õ–ï–ù–ò–ï –° –¢–ï–õ–ï–§–û–ù–ê =============
$("#arrowUp").on('touchstart mousedown', function(e) {
    e.preventDefault();
    keysPressed.w = true;
}).on('touchend mouseup mouseleave', function(e) {
    e.preventDefault();
    keysPressed.w = false;
});

$("#arrowDown").on('touchstart mousedown', function(e) {
    e.preventDefault();
    keysPressed.s = true;
}).on('touchend mouseup mouseleave', function(e) {
    e.preventDefault();
    keysPressed.s = false;
});

$("#arrowLeft").on('touchstart mousedown', function(e) {
    e.preventDefault();
    keysPressed.a = true;
}).on('touchend mouseup mouseleave', function(e) {
    e.preventDefault();
    keysPressed.a = false;
});

$("#arrowRight").on('touchstart mousedown', function(e) {
    e.preventDefault();
    keysPressed.d = true;
}).on('touchend mouseup mouseleave', function(e) {
    e.preventDefault();
    keysPressed.d = false;
});

$("#shootBtn").on('touchstart click', function(e) {
    e.preventDefault();
    if (gameState.isRunning && !gameState.isShooting && gameState.shots < 2 && gameState.currentTarget) {
        shoot();
    }
});

// ============= –ü–†–ê–í–ò–õ–ê =============
function showRules() {
    rulesModal.fadeIn(200);
}

function hideRules() {
    rulesModal.fadeOut(200);
    localStorage.setItem(RULES_SEEN_KEY, 'true');
}

// ============= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =============
async function init() {
    await loadStats();
    
    startBtn.text("–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É").prop('disabled', false);
    
    if (!localStorage.getItem(RULES_SEEN_KEY)) {
        showRules();
    }
    
    rulesBtn.on('click', showRules);
    closeRulesBtn.on('click', hideRules);
    endGameBtn.on('click', forceEndGame);
    restartGameBtn.on('click', restartGame);
    continueBtn.on('click', () => gameOverlay.fadeOut(200));
    
    await loadUsers();
    initKeyboardControls();
    startBtn.on('click', startGame);
}

$(document).ready(init);
</script>





<!-- –ö–£–ü–ò–î–û–ù -->
<script>

   // ============= –ö–û–ù–°–¢–ê–ù–¢–´ =============
    const CUPID_APP_ID = 16777213;
    const CUPID_STORAGE_KEY = 'cupid_stats';
    const CUPID_MAIN_URL = "https://pulseofny.rusff.me";
    
    let CUPID_userMap = {};
    let CUPID_usersLoaded = false;

    // ============= –¢–û–ß–ù–û –¢–ê–ö–û–ô –ñ–ï –ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô, –ö–ê–ö –í –ò–ì–†–ï =============
    async function CUPID_loadUsers() {
        console.log('üîç CUPID: –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
        
        if (CUPID_usersLoaded) {
            console.log(`‚úÖ CUPID: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã (${Object.keys(CUPID_userMap).length} —à—Ç)`);
            return CUPID_userMap;
        }
        
        return new Promise((resolve) => {
            const url = new URL(CUPID_MAIN_URL + "/api.php");
            url.searchParams.append("method", "users.get");
            url.searchParams.append("limit", 500); // config.avatarCount = 500
            url.searchParams.append("group_id", [1,2,6]);
            url.searchParams.append("fields", ["user_id", "username", "avatar"]);
            
            $.ajax({
                url: url.href,
                method: 'post',
                dataType: 'json',
                success: function(data) {
                    console.log('üì¶ CUPID: –û—Ç–≤–µ—Ç –æ—Ç users.get:', data);
                    
                    if (data.response?.users) {
                        const users = data.response.users.slice(0, 500);
                        console.log(`üë• CUPID: –ü–æ–ª—É—á–µ–Ω–æ ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã—Ö 3 –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
                        users.slice(0, 3).forEach((u, i) => {
                            console.log(`   –ü—Ä–∏–º–µ—Ä ${i+1}: user_id=${u.user_id}, username=${u.username}`);
                        });
                        
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º Map
                        users.forEach(u => {
                            CUPID_userMap[u.user_id.toString()] = u.username;
                        });
                        
                        CUPID_usersLoaded = true;
                        console.log(`‚úÖ CUPID: –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(CUPID_userMap).length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ Map`);
                    } else {
                        console.warn('‚ö†Ô∏è CUPID: –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –æ—Ç–≤–µ—Ç–µ');
                        
                        // –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–∞–∫ –≤ –∏–≥—Ä–µ
                        console.log('üß™ CUPID: –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                        for (let i = 0; i < 500; i++) {
                            const id = (1000 + i).toString();
                            CUPID_userMap[id] = `User${i + 1}`;
                        }
                        CUPID_usersLoaded = true;
                    }
                    
                    resolve(CUPID_userMap);
                },
                error: function(err) {
                    console.error('‚ùå CUPID: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', err);
                    
                    // –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –æ—à–∏–±–∫–µ, –∫–∞–∫ –≤ –∏–≥—Ä–µ
                    console.log('üß™ CUPID: –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ—à–∏–±–∫–∞ API)');
                    for (let i = 0; i < 500; i++) {
                        const id = (1000 + i).toString();
                        CUPID_userMap[id] = `User${i + 1}`;
                    }
                    CUPID_usersLoaded = true;
                    
                    resolve(CUPID_userMap);
                }
            });
        });
    }

    // ============= –ó–ê–ì–†–£–ó–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò =============
    async function CUPID_loadStats() {
        console.log('üîç CUPID: –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞...');
        
        try {
            const response = await $.get("/api.php", {
                token: ForumAPITicket,
                method: "storage.get",
                app_id: CUPID_APP_ID,
                key: [CUPID_STORAGE_KEY]
            });
            
            console.log('üì¶ CUPID: –û—Ç–≤–µ—Ç –æ—Ç storage.get:', response);
            
            if (response.response?.storage?.data?.[CUPID_STORAGE_KEY]) {
                const rawData = response.response.storage.data[CUPID_STORAGE_KEY];
                console.log('üìä CUPID: –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤):', rawData.substring(0, 200));
                
                const parsed = JSON.parse(rawData);
                console.log('üìä CUPID: –†–∞—Å–ø–∞—Ä—Å–µ–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', {
                    totalGames: parsed.totalGames,
                    totalScore: parsed.totalScore,
                    playersCount: Object.keys(parsed.players || {}).length,
                    pairsCount: Object.keys(parsed.pairs || {}).length,
                    targetsCount: Object.keys(parsed.targets || {}).length,
                    finalsCount: Object.keys(parsed.finals || {}).length
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã ID –∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                if (parsed.players) {
                    console.log('   –ü—Ä–∏–º–µ—Ä—ã ID –∏–≥—Ä–æ–∫–æ–≤:', Object.keys(parsed.players).slice(0, 5));
                }
                if (parsed.targets) {
                    console.log('   –ü—Ä–∏–º–µ—Ä—ã ID —Ü–µ–ª–µ–π:', Object.keys(parsed.targets).slice(0, 5));
                }
                if (parsed.finals) {
                    console.log('   –ü—Ä–∏–º–µ—Ä—ã ID —Ñ–∏–Ω–∞–ª–æ–≤:', Object.keys(parsed.finals).slice(0, 5));
                }
                
                return parsed;
            } else {
                console.warn('‚ö†Ô∏è CUPID: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ');
            }
        } catch (e) {
            console.error('‚ùå CUPID: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', e);
        }
        
        return {
            totalGames: 0,
            totalScore: 0,
            players: {},
            pairs: {},
            targets: {},
            finals: {}
        };
    }

    // ============= –û–ë–û–ì–ê–©–ï–ù–ò–ï –î–ê–ù–ù–´–• –ò–ú–ï–ù–ê–ú–ò =============
    function CUPID_enrichData(stats, userMap) {
        console.log('üîç CUPID: –ù–∞—á–∏–Ω–∞–µ–º –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–º–µ–Ω–∞–º–∏...');
        console.log('   userMap —Å–æ–¥–µ—Ä–∂–∏—Ç:', Object.keys(userMap).length, '–∑–∞–ø–∏—Å–µ–π');
        console.log('   –ü—Ä–∏–º–µ—Ä—ã –∏–∑ userMap (–ø–µ—Ä–≤—ã–µ 5):', Object.entries(userMap).slice(0, 5));
        
        // –û–±–æ–≥–∞—â–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤
        console.log('   üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º players...');
        const enrichedPlayers = {};
        let playersFound = 0, playersNotFound = 0;
        
        Object.entries(stats.players || {}).forEach(([id, data]) => {
            const idStr = id.toString();
            const name = userMap[idStr];
            
            if (name) {
                enrichedPlayers[name] = data;
                playersFound++;
                // console.log(`      ‚úÖ ${idStr} -> ${name}`);
            } else {
                // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –±–µ–∑ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
                const name2 = userMap[id];
                if (name2) {
                    enrichedPlayers[name2] = data;
                    playersFound++;
                    console.log(`      ‚úÖ ${id} (–±–µ–∑ toString) -> ${name2}`);
                } else {
                    enrichedPlayers[id] = data;
                    playersNotFound++;
                    console.warn(`      ‚ö†Ô∏è ID –∏–≥—Ä–æ–∫–∞ ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ userMap`);
                }
            }
        });
        console.log(`   ‚úÖ Players: –Ω–∞–π–¥–µ–Ω–æ ${playersFound}, –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ${playersNotFound}, –≤—Å–µ–≥–æ ${Object.keys(enrichedPlayers).length}`);
        
        // –û–±–æ–≥–∞—â–∞–µ–º –ø–∞—Ä—ã
        console.log('   üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º pairs...');
        const enrichedPairs = {};
        let pairsFound = 0, pairsNotFound = 0;
        
        Object.entries(stats.pairs || {}).forEach(([key, count]) => {
            const [id1, id2] = key.split('-');
            const id1Str = id1.toString();
            const id2Str = id2.toString();
            
            const name1 = userMap[id1Str] || userMap[id1] || id1;
            const name2 = userMap[id2Str] || userMap[id2] || id2;
            
            enrichedPairs[`${name1}-${name2}`] = count;
            
            if (!userMap[id1Str] && !userMap[id1]) {
                pairsNotFound++;
                console.warn(`      ‚ö†Ô∏è ID –ø–∞—Ä—ã ${id1} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ userMap`);
            }
            if (!userMap[id2Str] && !userMap[id2]) {
                pairsNotFound++;
                console.warn(`      ‚ö†Ô∏è ID –ø–∞—Ä—ã ${id2} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ userMap`);
            }
            pairsFound++;
        });
        console.log(`   ‚úÖ Pairs: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${pairsFound}, –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ${pairsNotFound}, –≤—Å–µ–≥–æ ${Object.keys(enrichedPairs).length}`);
        
        // –û–±–æ–≥–∞—â–∞–µ–º —Ü–µ–ª–∏
        console.log('   üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º targets...');
        const enrichedTargets = {};
        let targetsFound = 0, targetsNotFound = 0;
        
        Object.entries(stats.targets || {}).forEach(([id, count]) => {
            const idStr = id.toString();
            const name = userMap[idStr] || userMap[id] || id;
            
            enrichedTargets[name] = count;
            
            if (userMap[idStr] || userMap[id]) {
                targetsFound++;
            } else {
                targetsNotFound++;
                console.warn(`      ‚ö†Ô∏è ID —Ü–µ–ª–∏ ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ userMap`);
            }
        });
        console.log(`   ‚úÖ Targets: –Ω–∞–π–¥–µ–Ω–æ ${targetsFound}, –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ${targetsNotFound}, –≤—Å–µ–≥–æ ${Object.keys(enrichedTargets).length}`);
        
        // –û–±–æ–≥–∞—â–∞–µ–º —Ñ–∏–Ω–∞–ª—ã
        console.log('   üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º finals...');
        const enrichedFinals = {};
        let finalsFound = 0, finalsNotFound = 0;
        
        Object.entries(stats.finals || {}).forEach(([id, count]) => {
            const idStr = id.toString();
            const name = userMap[idStr] || userMap[id] || id;
            
            enrichedFinals[name] = count;
            
            if (userMap[idStr] || userMap[id]) {
                finalsFound++;
            } else {
                finalsNotFound++;
                console.warn(`      ‚ö†Ô∏è ID —Ñ–∏–Ω–∞–ª–∞ ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ userMap`);
            }
        });
        console.log(`   ‚úÖ Finals: –Ω–∞–π–¥–µ–Ω–æ ${finalsFound}, –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ${finalsNotFound}, –≤—Å–µ–≥–æ ${Object.keys(enrichedFinals).length}`);
        
        const result = {
            ...stats,
            players: enrichedPlayers,
            pairs: enrichedPairs,
            targets: enrichedTargets,
            finals: enrichedFinals
        };
        
        console.log('‚úÖ CUPID: –û–±–æ–≥–∞—â–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
        console.log('   –ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ - players (–ø–µ—Ä–≤—ã–µ 5):', Object.keys(result.players).slice(0, 5));
        console.log('   –ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ - targets (–ø–µ—Ä–≤—ã–µ 5):', Object.keys(result.targets).slice(0, 5));
        
        return result;
    }

    // ============= –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò =============
    function CUPID_validateStats(stats) {
        console.log('üîç CUPID: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π...');
        
        if (stats.players) {
            const playerKeys = Object.keys(stats.players);
            const numericKeys = playerKeys.filter(k => /^\d+$/.test(k));
            if (numericKeys.length > 0) {
                console.warn(`‚ö†Ô∏è CUPID: –í players –æ—Å—Ç–∞–ª–∏—Å—å —á–∏—Å–ª–æ–≤—ã–µ ID: ${numericKeys.slice(0, 5)}`);
            } else {
                console.log('‚úÖ CUPID: –í—Å–µ –∫–ª—é—á–∏ players ‚Äî –∏–º–µ–Ω–∞');
            }
        }
        
        if (stats.targets) {
            const targetKeys = Object.keys(stats.targets);
            const numericKeys = targetKeys.filter(k => /^\d+$/.test(k));
            if (numericKeys.length > 0) {
                console.warn(`‚ö†Ô∏è CUPID: –í targets –æ—Å—Ç–∞–ª–∏—Å—å —á–∏—Å–ª–æ–≤—ã–µ ID: ${numericKeys.slice(0, 5)}`);
            } else {
                console.log('‚úÖ CUPID: –í—Å–µ –∫–ª—é—á–∏ targets ‚Äî –∏–º–µ–Ω–∞');
            }
        }
        
        if (stats.finals) {
            const finalKeys = Object.keys(stats.finals);
            const numericKeys = finalKeys.filter(k => /^\d+$/.test(k));
            if (numericKeys.length > 0) {
                console.warn(`‚ö†Ô∏è CUPID: –í finals –æ—Å—Ç–∞–ª–∏—Å—å —á–∏—Å–ª–æ–≤—ã–µ ID: ${numericKeys.slice(0, 5)}`);
            } else {
                console.log('‚úÖ CUPID: –í—Å–µ –∫–ª—é—á–∏ finals ‚Äî –∏–º–µ–Ω–∞');
            }
        }
    }

    // ============= –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–û–ë–©–ï–ù–ò–ô =============
    window.addEventListener('message', async function(event) {
        console.log('üì® CUPID: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Ñ—Ä–µ–π–º–∞', event.data?.type, event.data?.requestId);
        
        if (event.data?.CUPID_stats && event.data.type === "CUPID_request") {
            console.log('üéØ CUPID: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            
            try {
                console.log('‚è≥ CUPID: –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
                const userMap = await CUPID_loadUsers();
                
                console.log('‚è≥ CUPID: –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...');
                const stats = await CUPID_loadStats();
                
                console.log('‚è≥ CUPID: –û–±–æ–≥–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ...');
                const enriched = CUPID_enrichData(stats, userMap);
                
                console.log('‚è≥ CUPID: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ...');
                CUPID_validateStats(enriched);
                
                console.log('üì§ CUPID: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —Ñ—Ä–µ–π–º—É');
                console.log('   players:', Object.keys(enriched.players).length, '–∑–∞–ø–∏—Å–µ–π');
                console.log('   pairs:', Object.keys(enriched.pairs).length, '–∑–∞–ø–∏—Å–µ–π');
                console.log('   targets:', Object.keys(enriched.targets).length, '–∑–∞–ø–∏—Å–µ–π');
                console.log('   finals:', Object.keys(enriched.finals).length, '–∑–∞–ø–∏—Å–µ–π');
                
                event.source.postMessage({
                    CUPID_stats: true,
                    type: "CUPID_response",
                    requestId: event.data.requestId,
                    data: enriched
                }, event.origin);
                
                console.log('‚úÖ CUPID: –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                
            } catch (error) {
                console.error('‚ùå CUPID: –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞', error);
                event.source.postMessage({
                    CUPID_stats: true,
                    type: "CUPID_response",
                    requestId: event.data.requestId,
                    data: null
                }, event.origin);
            }
        }
    });
    
    console.log('üöÄ CUPID: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    console.log('üåê CUPID: Main URL =', CUPID_MAIN_URL);
    
    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    console.log('‚è≥ CUPID: –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
    CUPID_loadUsers();

</script>

<!-- –ö–£–ü–ò–î–û–ù -->





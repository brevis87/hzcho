<!--------------рандом выпадение предметов-------------->

<!-- 1) Сначала подключаем библиотеку RandomImageLoader (иначе всё падает и рандом "умирает") -->
<script src="https://forumstatic.ru/files/001c/52/b6/39259.js"></script>

<style>
@keyframes pulse-contour-glow {
  0%   { filter: drop-shadow(0 0 3px rgba(255, 255, 100, 0.4)); }
  50%  { filter: drop-shadow(0 0 10px rgba(255, 255, 100, 0.9)) drop-shadow(0 0 15px rgba(255, 255, 100, 0.5)); }
  100% { filter: drop-shadow(0 0 3px rgba(255, 255, 100, 0.4)); }
}
.glow-image { animation: pulse-contour-glow 2s infinite alternate; }
</style>

<script>
(function () {

  // ===== ШАБЛОНЫ =====
  const ril_TMPL = {
    // Карточка на странице темы (HTML)
    IMAGE_IN_TOPIC: `
      <div class="random-image-container" style="position:absolute; z-index:1;">
        <label for="random-image-checkbox-{{id}}" class="random-image-label" style="cursor:pointer; display:inline-block;">
          <img src="https://upforme.ru/uploads/001c/84/76/2/774759.png"
               alt="{{name}}"
               title="ингредиент"
               class="glow-image"
               style="max-height:100px; width:auto; display:inline-block;"
               onload="this.parentNode.parentNode.style.left=Math.random()*600+'px'">
        </label>
      </div>
    `,

    // Инвентарь (BB)
    INVENTORY: `
[b]Инвентарь пользователя[/b]
[html]
<style>
  .usr_inv {display:grid; gap:10px; margin-top:10px; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));}
  .inv_item {border:1px solid #ddd; border-radius:4px; padding:10px; text-align:center;}
  .item-image {width:64px; height:64px; object-fit:cover; border-radius:4px;}
  .item-description {display:none;}
  #detailed-view-{{uniq}}:checked ~ .usr_inv {grid-template-columns:1fr;}
  #detailed-view-{{uniq}}:checked ~ .usr_inv .inv_item {display:flex; align-items:center; text-align:left; gap:15px; padding:15px;}
  #detailed-view-{{uniq}}:checked ~ .usr_inv .item-image {width:50px; height:50px; flex-shrink:0;}
  #detailed-view-{{uniq}}:checked ~ .usr_inv .item-description {display:block; flex:1;}
</style>

<div>
  <div class="usr_inv">
    {{items}}
  </div>
</div>
[/html]
[b]Последнее обновление:[/b] {{currentTime}}
    `,

    // Карточка одного предмета в инвентаре (HTML)
    // ✅ ДОБАВЛЕН pulse-donate, чтобы родитель мог считать предметы
    IMAGE_IN_INVENTORY: `
      <div class="inv_item">
        <img src="{{src}}" title="{{name}}" alt="{{name}}" class="item-image">

        <span class="pulse-donate"
              data-user=""
              data-userid=""
              data-topic=""
              data-url=""
              data-time=""
              data-item="{{name}}"
              data-qty="1"
              style="display:none"></span>
      </div>
    `,

    ALERTS: {
      SUCCESS: `Ты подобрал ингредиент "{{itemName}}"`,
      TOO_EARLY: `Стоило вам на миг отвернуться, и предмет исчез так, будто его никогда не было здесь.`,
      ERROR: `Ошибка при добавлении предмета`
    }
  };

  // ===== НАСТРОЙКИ =====
  const ril_ALLOWED = [1, 2, 6];     // группы, которым разрешено
  const USE_ALEX_NOTIFICATIONS = true;
  const FROM_ID = 1;
  const FROM_USERNAME = 'SYSTEM';

  const DROP_CHANCE = 0.9;           // шанс выпадения на странице
  const FILE_URL = 'https://forumstatic.ru/files/001c/84/76/52735.txt?v=3';
  const COOLDOWN_MIN = 0;           // минут между появлением
  const INVENTORY_TOPIC_ID = '21';   // ✅ ВАЖНО: тема (21), куда пишется/обновляется инвентарь

  // ===== СТАРТ =====
  $(document).ready(function () {

    if (typeof GroupID === "undefined") return;
    if (ril_ALLOWED.indexOf(GroupID) === -1) return;

    // уведомления (если есть)
    if (USE_ALEX_NOTIFICATIONS && typeof notifications != 'undefined') {
      notifications.addTemplate('ril_notif', {
        title: 'Получение предмета',
        url: '/viewtopic.php?pid={PID}#p{PID}',
        html: `<span>Предмет '<strong>{ITEM_NAME}</strong>' добавлен в Ваш <a href="/viewtopic.php?pid={PID}#p{PID}">Инвентарь</a><br /></span>`,
        description: 'Оповещать о добавлении предметов в инвентарь.'
      });
    }

    // работаем только в теме/редакторе
    if (window.location.href.indexOf("viewtopic") === -1 && window.location.href.indexOf("edit.php") === -1) return;

    // ✅ критично: проверяем, что RandomImageLoader реально загрузился
    if (typeof RandomImageLoader === "undefined") {
      console.error("❌ RandomImageLoader не найден. Проверь, что подключение 39259.js выше этого скрипта.");
      return;
    }

    const imageLoader = new RandomImageLoader(
      DROP_CHANCE,
      FILE_URL,
      COOLDOWN_MIN,
      INVENTORY_TOPIC_ID,
      ril_TMPL,
      USE_ALEX_NOTIFICATIONS,
      FROM_ID,
      FROM_USERNAME,
      false // debug
    );

    imageLoader.init();
  });

})();
</script>


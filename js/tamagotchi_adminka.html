<div class="tama-title">–ö–∞–±–∏–Ω–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¢–∞–º–∞–≥–æ—á–∏-–ó–æ–º–±–∏</div>

<style>
    #admin-wrap { background: #f4f4f4; padding: 20px; font-family: sans-serif; color: #333; max-width: 900px; margin: auto; }
    .admin-panel { background: #fff; border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .admin-panel h2 { margin-top: 0; font-size: 18px; border-bottom: 2px solid #007bff; padding-bottom: 5px; color: #007bff; }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    input, select, textarea { width: 100%; padding: 8px; margin: 5px 0 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    
    button { cursor: pointer; padding: 10px; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; }
    button.primary { background: #28a745; color: #fff; }
    button.warning { background: #ffc107; color: #000; }
    button.danger { background: #dc3545; color: #fff; }
    button.info { background: #17a2b8; color: #fff; }
    button:hover { opacity: 0.8; }

    .refresh-btn { background: #007bff; color: white; padding: 8px 15px; display: inline-block; cursor: pointer; margin-bottom: 10px; border-radius: 4px; font-weight: bold; }
    
    #bonusList { max-height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 5px; }
    #adminLogs { height: 120px; overflow-y: auto; background: #333; color: #0f0; padding: 10px; font-size: 11px; font-family: monospace; border-radius: 4px; }
    
    .stat-edit-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
    .stat-edit-row label { width: 100px; font-size: 12px; font-weight: bold; }
</style>

<div id="admin-wrap">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div class="refresh-btn" onclick="init()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞</div>
        <div id="syncStatus" style="font-size: 12px; color: #666;"></div>
    </div>
    
    <div class="grid-2">
<div class="admin-panel">
    <h2>üß™ –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ó–æ–º–±–∏</h2>
    <div id="statsControls">
        <div class="stat-edit-row"><label>HP:</label><input type="number" id="edit_hp" max="100"></div>
        <div class="stat-edit-row"><label>–°—ã—Ç–æ—Å—Ç—å:</label><input type="number" id="edit_hunger" max="100"></div>
        <div class="stat-edit-row"><label>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:</label><input type="number" id="edit_mood" max="100"></div>
        <div class="stat-edit-row"><label>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</label><input type="number" id="edit_activity" max="100"></div> <div class="stat-edit-row"><label>–ò–Ω—Ñ–µ–∫—Ü–∏—è:</label><input type="number" id="edit_infection" max="100"></div>
        <button class="primary" style="width:100%" onclick="updateZombieStats()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
    </div>
    <hr>
    <button class="danger" style="width:100%; margin-top: 10px;" onclick="resurrectZombie()">‚ö° –í–û–°–ö–†–ï–°–ò–¢–¨ (Full Reset)</button>
</div>

        <div class="admin-panel">
            <h2>üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–º</h2>
            <label>–ù–∏–∫–Ω–µ–π–º:</label>
            <input type="text" id="username" placeholder="–¢–æ—á–Ω—ã–π –Ω–∏–∫ –∏–≥—Ä–æ–∫–∞">
            
            <div class="grid-2" style="margin-bottom: 10px;">
                <button class="primary" onclick="modifyBonuses('add')">üéÅ + –ë–æ–Ω—É—Å</button>
                <button class="warning" onclick="modifyBonuses('remove')">‚ûñ - –ë–æ–Ω—É—Å</button>
            </div>
            <input type="number" id="bonusAmount" value="5" placeholder="–ö–æ–ª-–≤–æ">
            <button class="info" style="width: 100%" onclick="resetUserActions()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –ª–∏–º–∏—Ç (9/9)</button>
            <button class="danger" style="width: 100%; margin-top:5px; font-size: 10px;" onclick="resetUserRating()">üóë –û–±–Ω—É–ª–∏—Ç—å –¢–û–ü –∏–≥—Ä–æ–∫–∞</button>
        </div>
    </div>

    <div class="admin-panel">
        <div style="display:flex; justify-content: space-between;">
            <h2>üìä –°–ø–∏—Å–æ–∫ –±–æ–Ω—É—Å–æ–≤ –∏ –ø–æ–∏—Å–∫</h2>
            <input type="text" id="userSearch" placeholder="–ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–∞..." onkeyup="filterUsers()" style="width: 200px; margin: 0;">
        </div>
        <div id="bonusList">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>

    <div class="admin-panel">
        <h2>üìù –õ–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∞</h2>
        <div id="adminLogs"></div>
    </div>
</div>

<script>
const APP = 16777213;
const KEY = "GLOBAL_ZOMBIE_TAMA";
const ADMIN_NAME = window.UserLogin || "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä";
let state = null;

async function loadState() {
    try {
        const resp = await fetch(`/api.php?token=${window.ForumAPITicket || ''}&method=storage.get&app_id=${APP}&key=${KEY}`);
        const json = await resp.json();
        const raw = json?.response?.storage?.data?.[KEY];
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed.data || parsed;
    } catch (e) { return null; }
}

async function saveState(updateFn) {
    // 1. –°–∫–∞—á–∏–≤–∞–µ–º —Å–∞–º–æ–µ —Å–≤–µ–∂–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–≤–∞–∂–Ω–æ!)
    const currentState = await loadState();
    if (!currentState) return alert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.");

    // 2. –í–Ω–æ—Å–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞ –≤ –°–í–ï–ñ–ò–ï –¥–∞–Ω–Ω—ã–µ
    if (typeof updateFn === 'function') {
        updateFn(currentState);
    } else {
        Object.assign(currentState, updateFn);
    }

    // 3. –°—Ç–∞–≤–∏–º –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ß–£–¢–¨ –í–ü–ï–†–ï–î (–Ω–∞ 1 —Å–µ–∫—É–Ω–¥—É), —á—Ç–æ–±—ã –ø–µ—Ä–µ–∫—Ä—ã—Ç—å —Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–æ–≤
    currentState.lastUpdate = Date.now() + 1000;

    const fd = new FormData();
    fd.append('token', window.ForumAPITicket || '');
    fd.append('method', 'storage.set');
    fd.append('app_id', APP);
    fd.append('key', KEY);
    fd.append('value', JSON.stringify({ data: currentState }));
    
    const response = await fetch('/api.php', { method: 'POST', body: fd });
    const result = await response.json();

    if (result.error) {
        alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏!");
    } else {
        state = currentState;
        renderAdmin();
        document.getElementById('syncStatus').textContent = "–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: " + new Date().toLocaleTimeString();
        addLocalLog("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ –±–∞–∑—É.");
    }
}

// --- –§–£–ù–ö–¶–ò–ò, –ö–û–¢–û–†–´–ï –û–¢–°–£–¢–°–¢–í–û–í–ê–õ–ò –ò–õ–ò –ù–ï –†–ê–ë–û–¢–ê–õ–ò ---

async function updateZombieStats() {
    await saveState((freshState) => {
        freshState.hp = parseInt(document.getElementById('edit_hp').value) || 0;
        freshState.hunger = parseInt(document.getElementById('edit_hunger').value) || 0;
        freshState.mood = parseInt(document.getElementById('edit_mood').value) || 0;
        freshState.activity = parseInt(document.getElementById('edit_activity').value) || 0;
        freshState.infection = parseInt(document.getElementById('edit_infection').value) || 0;
        
        if(freshState.hp > 0) freshState.isDead = false;

        freshState.logs.unshift({
            text: `üì¢ SYSTEM: –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∑–æ–º–±–∏ –∏–∑–º–µ–Ω–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.`,
            cssClass: 'admin-message'
        });
        freshState.logs = freshState.logs.slice(0, 30); // –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ 30 –∑–∞–ø–∏—Å–µ–π
    });
    addLocalLog("–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–æ–º–±–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.");
}

async function modifyBonuses(mode) {
    const user = document.getElementById('username').value.trim();
    const val = parseInt(document.getElementById('bonusAmount').value);
    if (!user || isNaN(val)) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∏–∫ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ");

    await saveState((freshState) => {
        if (!freshState.bonuses) freshState.bonuses = {};
        const current = parseInt(freshState.bonuses[user] || 0);
        freshState.bonuses[user] = Math.max(0, mode === 'add' ? current + val : current - val);

        freshState.logs.unshift({
            text: `üì¢ SYSTEM: ${user} ${mode === 'add' ? '–ø–æ–ª—É—á–∏–ª' : '–ø–æ—Ç–µ—Ä—è–ª'} ${val} –±–æ–Ω. –¥–µ–π—Å—Ç–≤–∏–π.`,
            cssClass: 'admin-message'
        });
    });
    addLocalLog(`${mode === 'add' ? '–î–æ–±–∞–≤–ª–µ–Ω–æ' : '–°–Ω—è—Ç–æ'} ${val} –±–æ–Ω—É—Å–æ–≤ –¥–ª—è ${user}`);
}

async function resetUserActions() {
    const user = document.getElementById('username').value.trim();
    if (!user) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫");
    
    await saveState((freshState) => {
        // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ –æ –¥–µ–π—Å—Ç–≤–∏—è—Ö –∑–∞ –°–ï–ì–û–î–ù–Ø, —á—Ç–æ–±—ã —É –∏–≥—Ä–æ–∫–∞ —Å–Ω–æ–≤–∞ —Å—Ç–∞–ª–æ 9/9
        if (freshState.actions && freshState.actions[user]) {
            delete freshState.actions[user];
            freshState.logs.unshift({ 
                text: `üì¢ SYSTEM: –õ–∏–º–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π ${user} —Å–±—Ä–æ—à–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.`, 
                cssClass: 'admin-message' 
            });
        }
    });
    alert("–õ–∏–º–∏—Ç –¥–ª—è " + user + " —Å–±—Ä–æ—à–µ–Ω!");
}

async function resetUserRating() {
    const user = document.getElementById('username').value.trim();
    if (!user || !confirm(`–û–±–Ω—É–ª–∏—Ç—å –æ—á–∫–∏ –≤ –¢–û–ü–µ –¥–ª—è ${user}?`)) return;

    await saveState((freshState) => {
        if (!freshState.rating) freshState.rating = {};
        freshState.rating[user] = 0;
    });
    addLocalLog(`–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–∞ ${user} –æ–±–Ω—É–ª–µ–Ω`);
}

async function resurrectZombie() {
    if (!confirm("–í–æ—Å–∫—Ä–µ—Å–∏—Ç—å –∑–æ–º–±–∏? –õ–∏–º–∏—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π 9/9 –±—É–¥—É—Ç —Å–±—Ä–æ—à–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö!")) return;
    
    await saveState((freshState) => {
        freshState.hp = 70;
        freshState.hunger = 60;
        freshState.mood = 50;
        freshState.activity = 60;
        freshState.infection = 10;
        freshState.isDead = false;
        freshState.createdAt = Date.now();
        freshState.rating = {}; 
        freshState.actions = {}; // –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ, –≥–¥–µ –æ–±–Ω—É–ª—è—é—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏—è –í–°–ï–•
        freshState.logs.unshift({ 
            text: `‚ö° –°–ò–°–¢–ï–ú–ù–û–ï: –ó–æ–º–±–∏ –≤–æ—Å–∫—Ä–µ—à–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!`, 
            cssClass: 'admin-message' 
        });
        freshState.logs = freshState.logs.slice(0, 20);
    });
    addLocalLog("–ó–æ–º–±–∏ –≤–æ—Å–∫—Ä–µ—à–µ–Ω.");
    alert("–ó–æ–º–±–∏ –≤–æ—Å–∫—Ä–µ—à–µ–Ω!");
}

// --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–†–ï–ù–î–ï–†) ---

function filterUsers() {
    const val = document.getElementById('userSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#bonusTable tr');
    rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(val) ? '' : 'none';
    });
}

function renderAdmin() {
    if (!state) return;
    document.getElementById('edit_hp').value = Math.round(state.hp || 0);
    document.getElementById('edit_hunger').value = Math.round(state.hunger || 0);
    document.getElementById('edit_mood').value = Math.round(state.mood || 0);
    document.getElementById('edit_activity').value = Math.round(state.activity || 0);
    document.getElementById('edit_infection').value = Math.round(state.infection || 0);

    const list = document.getElementById('bonusList');
    if (!state.bonuses) { list.innerHTML = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"; return; }

    let html = '<table id="bonusTable" style="width:100%; border-collapse:collapse; font-size: 13px;">';
    Object.entries(state.bonuses).forEach(([user, count]) => {
        html += `<tr style="border-bottom:1px solid #eee">
            <td style="padding:8px">${user}</td>
            <td style="padding:8px"><b>${count}</b> üéÅ</td>
            <td style="text-align:right">
                <button class="info" style="padding:2px 8px;" onclick="document.getElementById('username').value='${user}'">–í—ã–±—Ä–∞—Ç—å</button>
            </td>
        </tr>`;
    });
    html += '</table>';
    list.innerHTML = html;
}

function addLocalLog(msg) {
    const logDiv = document.getElementById('adminLogs');
    logDiv.innerHTML = `<div style="margin-bottom:2px;">> [${new Date().toLocaleTimeString()}] ${msg}</div>` + logDiv.innerHTML;
}

async function init() {
    state = await loadState();
    if (state) {
        renderAdmin();
        addLocalLog("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.");
    }
}
init();
</script>

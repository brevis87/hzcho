<div class="tama-title" style="display:none;">–¢–∞–º–∞–≥–æ—á–∏-–ó–æ–º–±–∏</div>



<style>

#wrap { 
    background: url('https://upforme.ru/uploads/001c/84/76/2/180199.png') no-repeat center;
    background-size: 100% 100%;
    height: 100%; 
    width: 100%;
position: relative;
    overflow: hidden; 
    color: #000; 
    padding: 50px; /* –ß—É—Ç—å —É–º–µ–Ω—å—à–∏–ª padding, —á—Ç–æ–±—ã –≤–ª–µ–∑–ª–æ –±–æ–ª—å—à–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
    font-family: 'Arial', sans-serif; 
    display: grid; 
    grid-template-columns: 160px 1fr 300px; /* –ù–µ–º–Ω–æ–≥–æ —Ä–∞—Å—à–∏—Ä–∏–ª –ª–µ–≤—É—é –ø–æ–¥ –¢–û–ü */
    gap: 50px; /* –£–º–µ–Ω—å—à–∏–ª –∑–∞–∑–æ—Ä –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏ (–±—ã–ª–æ 70) */
    box-sizing: border-box; 
}

.paper-block { background: #e9e5d3; padding: 15px; position: relative; display: flex; flex-direction: column; }

.block-title { font-size: 18px; font-weight: bold; text-transform: uppercase; border-bottom: 2px solid #333; margin-bottom: 10px; padding-bottom: 5px; }

/* –£–∫–∞–∑—ã–≤–∞–µ–º –ª–µ–≤–æ–π –∫–æ–ª–æ–Ω–∫–µ –∑–∞–Ω—è—Ç—å –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É—é –≤—ã—Å–æ—Ç—É */
.left-col { 
    display: flex; 
    flex-direction: column; 
    gap: 20px; 
    height: 100%; 
}

/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¢–û–ü–∞: —Ä–∞–∑—Ä–µ—à–∞–µ–º –µ–º—É —Ä–∞—Å—Ç–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
#rating { 
    font-size: 15px; 
    line-height: 1.8; 
    font-weight: bold; 
    overflow-y: auto; /* –ü–æ—è–≤–∏—Ç—Å—è —Å–∫—Ä–æ–ª–ª, –µ—Å–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ –º–Ω–æ–≥–æ */
    flex-grow: 1;     /* –ó–∞—Å—Ç–∞–≤–∏—Ç –±–ª–æ–∫ —Ä–∞—Å—Ç—è–Ω—É—Ç—å—Å—è –¥–æ —Å—á–µ—Ç—á–∏–∫–æ–≤ */
    padding-right: 5px; /* –û—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª –Ω–µ –Ω–∞–ª–µ–∑–∞–ª –Ω–∞ —Ç–µ–∫—Å—Ç */
}

/* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –±–ª–æ–∫–∞ –¢–û–ü–∞, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –≤—ã—Ç–∞–ª–∫–∏–≤–∞–ª —Å—á–µ—Ç—á–∏–∫–∏ –∑–∞ —ç–∫—Ä–∞–Ω */
.left-col .paper-block:first-child {
    flex-grow: 1;
    max-height: 500px; /* –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —ç—Ç–æ —á–∏—Å–ª–æ –ø–æ–¥ –≤–∞—à —ç–∫—Ä–∞–Ω, —á—Ç–æ–±—ã –¢–û–ü –Ω–µ –±—ã–ª —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–º */
    display: flex;
    flex-direction: column;
}

.rating-item { display: flex; justify-content: space-between; border-bottom: 1px dashed #999; }

.counters-area { 
    margin-top: -8px; /* –ü—Ä–∏–∂–º–µ—Ç –±–ª–æ–∫ –∫ –Ω–∏–∑—É –ª–µ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ */
    padding: 10px;    /* –£–º–µ–Ω—å—à–∏–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã, —á—Ç–æ–±—ã —Å–∂–∞—Ç—å –±–ª–æ–∫ */
}

.counter-row { 
    display: flex; 
    align-items: center; 
    gap: 5px; 
    margin-bottom: 8px; /* –£–º–µ–Ω—å—à–∏–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏ (–±—ã–ª–æ 15) */
    background: rgba(0,0,0,0.03); /* –õ–µ–≥–∫–∞—è –ø–æ–¥–ª–æ–∂–∫–∞ –∫–∞–∫ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ */
    padding: 5px;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –∏ —Ü–∏—Ñ—Ä –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ */
.counter-info-container {
    display: flex;
    justify-content: space-between; /* –†–ê–°–°–¢–ê–õ–ö–ò–í–ê–ï–¢ —Ç–µ–∫—Å—Ç –≤–ª–µ–≤–æ, –∞ —á–∏—Å–ª–æ –≤–ø—Ä–∞–≤–æ */
    align-items: flex-start;
    width: 100%; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ —Å–ø—Ä–∞–≤–∞ –æ—Ç –∏–∫–æ–Ω–∫–∏ */
}

.counter-row img { width: 35px; height: 35px; }

/* –°—Ç–∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–î–æ—Å—Ç—É–ø–Ω–æ –¥–µ–π—Å—Ç–≤–∏–π / –ë–æ–Ω—É—Å–Ω—ã—Ö) */
.counter-label { 
    font-size: 10px; 
    font-weight: 900; 
    text-transform: uppercase;
    line-height: 1.2;
    color: #222;
}

/* –°—Ç–∏–ª–∏ –±–æ–ª—å—à–∏—Ö —Ü–∏—Ñ—Ä —Å–ø—Ä–∞–≤–∞ */
.counter-val { 
    font-size: 28px; 
    font-weight: 900; 
    color: #008b8b; 
    line-height: 1;
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º */
.reset-timer, .counter-subtext {
    font-size: 11px;
    font-weight: bold;
    margin-top: 5px;
}

.reset-timer { font-size: 11px; color: #b22222; font-weight: bold; margin-top: 4px; }

.center-col { display: flex; flex-direction: column; align-items: center; }

.time-bubble { background: #e9e5d3; padding: 10px 20px; font-size: 18px; font-weight: bold; margin-bottom: 20px; }

.zombie-display { width: 300px; height: 350px; position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; overflow: visible; /* –ß—Ç–æ–±—ã —á–∞—Å—Ç–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –≥–∏—Ñ–∫–∏ –Ω–µ –≤—ã–ª–µ–∑–∞–ª–∏ –∑–∞ –∫—Ä–∞—è */ }

.zombie-display img { 
width: 350px;          /* –ó–∞–¥–∞–π—Ç–µ —Ç—É —à–∏—Ä–∏–Ω—É, –∫–æ—Ç–æ—Ä–∞—è –≤–∞–º –∫–∞–∂–µ—Ç—Å—è –∏–¥–µ–∞–ª—å–Ω–æ–π */
    height: 350px;         /* –ó–∞–¥–∞–π—Ç–µ —Ç—É –∂–µ –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –æ–±–ª–∞—Å—Ç—å –±—ã–ª–∞ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π */
    object-fit: contain;   /* –í–ê–ñ–ù–û: —ç—Ç–æ –≤–ø–∏—à–µ—Ç –≥–∏—Ñ–∫—É –≤ –∫–≤–∞–¥—Ä–∞—Ç 250x250 –±–µ–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π –∏ –æ–±—Ä–µ–∑–∫–∏ */
    position: absolute;    /* –ß—Ç–æ–±—ã –æ–Ω–∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–ª–∏—Å—å –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ –≤ –æ–¥–Ω–æ–π —Ç–æ—á–∫–µ */
    transition: 0.3s;      /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å (–ø–æ –∂–µ–ª–∞–Ω–∏—é) */
bottom: -80px;
}

.stats-wrap { width: 100%; max-width: 450px; margin-top: 80px; }

.stat-row { margin-bottom: 10px; }

.stat-head { display: flex; justify-content: space-between; font-size: 11px; font-weight: bold; color: #fff; text-transform: uppercase; margin-bottom: 3px; }

.bar { height: 14px; background: #222; border: 1px solid #444; }

.fill { height: 100%; transition: width 0.5s ease-in-out; }

.right-col { display: flex; flex-direction: column; gap: 20px; }

.action-btn { background: none; border: 1px solid transparent; display: flex; align-items: center; padding: 6px; cursor: pointer; text-align: left; width: 100%; transition: 0.2s; }

.action-btn:hover:not(:disabled) { background: rgba(0,0,0,0.05); border-color: #999; }

.action-btn:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }

.action-btn img { width: 42px; height: 42px; margin-right: 12px; }

.act-name { display: block; font-size: 17px; font-weight: bold; text-transform: uppercase; }

.act-desc { display: block; font-size: 10px; color: #555; }

#logs { height: 150px; overflow-y: auto; font-size: 11px; font-family: monospace; background: rgba(255,255,255,0.2); padding: 8px; border: 1px solid #ccc; }

.death-message { color: #f44 !important; font-weight: bold; }

.admin-message { color: #007bff !important; font-weight: bold; }

.emotion-indicator { position: absolute; top: 0; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 12px; opacity: 0; transition: 0.3s; z-index: 10; }

.emotion-indicator.show { opacity: 1; top: -20px; }

.loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 9999; display: flex; align-items: center; justify-content: center; color: #fff; }

/* –ö–Ω–æ–ø–∫–∞ –≤ —É–≥–ª—É */
.info-btn-wrapper {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 100;
line-height: 0; /* –£–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã —Å–Ω–∏–∑—É —É –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
}

.info-icon {
    width: 45px;
    height: 45px;
    cursor: pointer;
    transition: transform 0.2s, filter 0.2s;
    filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
}

.info-icon:hover {
    transform: scale(1.1);
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
.info-modal {
    display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 2000;
    justify-content: center;
    align-items: center;
}

.info-content {
    width: 350px;
    max-height: 80vh;
    overflow-y: auto;
    animation: fadeIn 0.3s ease;
}

.info-text {
    font-size: 13px;
    line-height: 1.4;
    color: #333;
}

.info-text ul {
    padding-left: 20px;
    margin: 10px 0;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

</style>



<div id="wrap">

<div class="info-btn-wrapper">
    <img src="https://upforme.ru/uploads/001c/84/76/2/414706.png" class="info-icon" onclick="toggleInfoModal()" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–≥—Ä–µ">
</div>

<div id="infoModal" class="info-modal">
    <div class="info-content paper-block">
        <div class="block-title">üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</div>
        <div class="info-text">
            <p><b>–¶–µ–ª—å –∏–≥—Ä—ã:</b> –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∂–∏–∑–Ω—å –∑–æ–º–±–∏ –∫–∞–∫ –º–æ–∂–Ω–æ –¥–æ–ª—å—à–µ.</p>
            <ul>
                <li><b>–°—ã—Ç–æ—Å—Ç—å:</b> –ü–∞–¥–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ –≤—Å–µ–≥–æ. –ö–æ—Ä–º–∏—Ç–µ –≤–æ–≤—Ä–µ–º—è.</li>
                <li><b>–ò–Ω—Ñ–µ–∫—Ü–∏—è:</b> –ï—Å–ª–∏ –æ–Ω–∞ –≤—ã—à–µ 85%, –∑–¥–æ—Ä–æ–≤—å–µ –Ω–∞—á–Ω–µ—Ç –±—ã—Å—Ç—Ä–æ —É—Ö–æ–¥–∏—Ç—å.</li>
                <li><b>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:</b> –ï—Å–ª–∏ —É–ø–∞–¥–µ—Ç –Ω–∏–∂–µ 15%, –∑–æ–º–±–∏ –Ω–∞—á–Ω–µ—Ç —Ç–µ—Ä—è—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ –æ—Ç —Ç–æ—Å–∫–∏.</li>
                <li><b>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</b> –ü—Ä–∏ —É—Ä–æ–≤–Ω–µ –Ω–∏–∂–µ 10% –Ω–∞–Ω–æ—Å–∏—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —É—Ä–æ–Ω.</li>
                <li><b>–†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è:</b> –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤—ã—à–µ 90% –∏ –∏–Ω—Ñ–µ–∫—Ü–∏—è –Ω–∏–∑–∫–∞—è, –∑–¥–æ—Ä–æ–≤—å–µ –∑–æ–º–±–∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–∞–º–æ.</li>
                <li><b>–°–º–µ—Ä—Ç—å:</b> –ï—Å–ª–∏ –∑–¥–æ—Ä–æ–≤—å–µ —É–ø–∞–¥–µ—Ç –¥–æ 0, –¥–µ–π—Å—Ç–≤–∏—è –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –¥–æ –≤–æ—Å–∫—Ä–µ—à–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</li>

            </ul>
            <p><i>–ù–æ—á—å—é (00:00 - 08:00) –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–∞–¥–∞—é—Ç –Ω–∞ 10% –º–µ–¥–ª–µ–Ω–Ω–µ–µ.</i></p>
        </div>
        <button class="action-btn" onclick="toggleInfoModal()" style="margin-top:15px; justify-content:center;"><b>–ó–ê–ö–†–´–¢–¨</b></button>
    </div>
</div>

    <div id="loadingOverlay" class="loading-overlay">–ó–ê–ì–†–£–ó–ö–ê...</div>

    <div class="left-col">

        <div class="paper-block">

            <div class="block-title">üèÜ –¢–û–ü –ò–ì–†–û–ö–û–í</div>

            <div id="rating"></div>

        </div>

<div class="paper-block counters-area">

    <div class="counter-row">
        <img src="https://upforme.ru/uploads/001c/84/76/2/177104.png">
        <div class="counter-info-container">
            <div>
                <div class="counter-label">–î–û–°–¢–£–ü–ù–û<br>–î–ï–ô–°–¢–í–ò–ô</div>
                <div id="actionsTimer" class="reset-timer" style="color: #8eb93b;">–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 00:00:00</div>
            </div>
            <div class="counter-val" id="actionsCounter">9/9</div>
        </div>
    </div>

    <div class="counter-row">
        <img src="https://upforme.ru/uploads/001c/84/76/2/662919.png">
        <div class="counter-info-container">
            <div>
                <div class="counter-label" style="color: #b22222;">–ë–û–ù–£–°–ù–´–•<br>–î–ï–ô–°–¢–í–ò–ô</div>
                <div class="counter-subtext" style="color: #d112bb;">*–ø–æ–∫—É–ø–∞–µ—Ç—Å—è –∑–∞ –∏–≥—Ä–æ–≤—É—é –≤–∞–ª—é—Ç—É</div>
            </div>
            <div class="counter-val" id="bonusActions" style="color: #b22222;">0</div>
        </div>
    </div>

</div>

    </div>

    <div class="center-col">

        <div class="time-bubble">–ó–æ–º–±–∏ –ø—Ä–æ–∂–∏–ª: <span id="aliveInfo" style="color:#8eb93b">0 –¥., 0 —á.</span></div>

        <div class="zombie-display">

            <div id="emotionIndicator" class="emotion-indicator"></div>

            <img id="zombieImage" src="https://upforme.ru/uploads/001c/84/76/2/443090.gif">

            <img id="happyGif" src="https://upforme.ru/uploads/001c/84/76/2/925156.gif" style="display:none; position:absolute;">

            <img id="angryGif" src="https://upforme.ru/uploads/001c/84/76/2/171339.gif" style="display:none; position:absolute;">

            <img id="sadImage" src="https://upforme.ru/uploads/001c/84/76/2/581889.gif" style="display:none; position:absolute;">

            <img id="deadZombieImage" src="https://upforme.ru/uploads/001c/84/76/2/313667.gif" style="display:none; position:absolute;">

        </div>

        <div class="stats-wrap">

            <div class="stat-row"><div class="stat-head"><span>–ó–¥–æ—Ä–æ–≤—å–µ</span> <span id="hpValue">0</span>/100</div><div class="bar"><div id="hp" class="fill" style="background:red;"></div></div></div>

            <div class="stat-row"><div class="stat-head"><span>–°—ã—Ç–æ—Å—Ç—å</span> <span id="hungerValue">0</span>/100</div><div class="bar"><div id="hunger" class="fill" style="background:orange;"></div></div></div>

            <div class="stat-row"><div class="stat-head"><span>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span> <span id="moodValue">0</span>/100</div><div class="bar"><div id="mood" class="fill" style="background:deepskyblue;"></div></div></div>

            <div class="stat-row"><div class="stat-head"><span>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span> <span id="activityValue">0</span>/100</div><div class="bar"><div id="activity" class="fill" style="background:limegreen;"></div></div></div>

            <div class="stat-row"><div class="stat-head"><span>–ò–Ω—Ñ–µ–∫—Ü–∏—è</span> <span id="infectionValue">0</span>/100</div><div class="bar"><div id="infection" class="fill" style="background:purple;"></div></div></div>

        </div>

    </div>

    <div class="right-col">

        <div class="paper-block">

            <div class="block-title">–î–ï–ô–°–¢–í–ò–Ø</div>

            <button class="action-btn" onclick="doAction('feed')"><img src="https://upforme.ru/uploads/001c/84/76/2/476415.png"><span><span class="act-name">–ö–æ—Ä–º–∏—Ç—å</span><span class="act-desc">+30 —Å—ã—Ç–æ—Å—Ç—å, -5 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span></span></button>

            <button class="action-btn" onclick="doAction('play')"><img src="https://upforme.ru/uploads/001c/84/76/2/671196.png"><span><span class="act-name">–†–∞–∑–≤–ª–µ—á—å</span><span class="act-desc">+25 –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span></span></button>

            <button class="action-btn" onclick="doAction('heal')"><img src="https://upforme.ru/uploads/001c/84/76/2/818211.png"><span><span class="act-name">–õ–µ—á–∏—Ç—å</span><span class="act-desc">+15 –∑–¥–æ—Ä–æ–≤—å–µ, -40 –∏–Ω—Ñ–µ–∫—Ü–∏—è</span></span></button>

            <button class="action-btn" onclick="doAction('energize')"><img src="https://upforme.ru/uploads/001c/84/76/2/998081.png"><span><span class="act-name">–í–∑–±–æ–¥—Ä–∏—Ç—å</span><span class="act-desc">+35 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, -10 –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span></span></button>

            <button class="action-btn" onclick="doAction('sabotage')"><img src="https://upforme.ru/uploads/001c/84/76/2/493297.png"><span><span class="act-name">–°–∞–±–æ—Ç–∞–∂</span><span class="act-desc">+15 –∏–Ω—Ñ.</span></span></button>

        </div>

        <div class="paper-block" style="margin-top: 90px;"><div class="block-title">üìù –ñ–£–†–ù–ê–õ</div><div id="logs"></div></div>

    </div>

</div>



<script>
const KEY = "GLOBAL_ZOMBIE_TAMA";
const APP = 16777213;
const USER = window.UserLogin || "–ò–≥—Ä–æ–∫";
const MAX_ACTIONS = 9;
let state = null;
let lastRequestTime = 0;
let isAnimating = false;

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
function getMoscowNow() { return new Date(new Date().getTime() + (new Date().getTimezoneOffset() * 60000) + (3 * 3600000)); }
function getMoscowDateStr() { return getMoscowNow().toISOString().split('T')[0]; }
function getFullLogDate() { const n = new Date(); return `${n.getDate().toString().padStart(2,'0')}.${(n.getMonth()+1).toString().padStart(2,'0')} ${n.getHours().toString().padStart(2,'0')}:${n.getMinutes().toString().padStart(2,'0')}`; }

class API {
    static async get() {
        if (Date.now() - lastRequestTime < 2000) return null;
        lastRequestTime = Date.now();
        try {
            const resp = await fetch(`/api.php?token=${window.ForumAPITicket || ''}&method=storage.get&app_id=${APP}&key=${KEY}`);
            const json = await resp.json();
            const raw = json?.response?.storage?.data?.[KEY];
            if(!raw) return null;
            const parsed = JSON.parse(raw);
            return parsed.data || parsed;
        } catch (e) { return null; }
    }
    static async set(data) {
        lastRequestTime = Date.now();
        const fd = new FormData();
        fd.append('token', window.ForumAPITicket || '');
        fd.append('method', 'storage.set');
        fd.append('app_id', APP);
        fd.append('key', KEY);
        fd.append('value', JSON.stringify({ data }));
        await fetch('/api.php', { method: 'POST', body: fd });
    }
}

// –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ –ò–ó–ú–ï–ù–ï–ù–ò–ô (—Å —É—á–µ—Ç–æ–º –æ—Ñ—Ñ–ª–∞–π–Ω–∞)
let isSyncing = false; // –î–æ–±–∞–≤—å—Ç–µ –≤ –Ω–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞ –∫ –æ—Å—Ç–∞–ª—å–Ω—ã–º let

async function gameTick() {
    if (isSyncing) return; // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É–∂–µ –∏–¥–µ—Ç, –Ω–µ –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π
    isSyncing = true;

    const remote = await API.get();
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –º—ã —Å–µ–π—á–∞—Å –Ω–µ –∑–∞–Ω—è—Ç—ã –∞–Ω–∏–º–∞—Ü–∏–µ–π
    if (remote && !isAnimating) state = remote;
    
    if (!state || state.isDead) {
        isSyncing = false;
        return;
    }

    const now = Date.now();
    const elapsedMs = now - (state.lastUpdate || now);
    const intervals = Math.max(0, Math.floor(elapsedMs / 15000)); 

    for(let i = 0; i < intervals; i++) {
        const checkTime = new Date((state.lastUpdate || now) + (i * 15000));
        const hour = (checkTime.getUTCHours() + 3) % 24;
        const isNight = (hour >= 0 && hour < 8);
        const factor = isNight ? 0.2 : 1.0; 

        state.hunger = Math.max(0, state.hunger - (0.2 * factor));
        state.mood = Math.max(0, state.mood - (0.15 * factor));
        state.activity = Math.max(0, state.activity - (0.15 * factor));
        state.infection = Math.min(100, state.infection + (0.15 * factor));
        
        let hpChange = 0;
        // –®–¢–†–ê–§–´
        if (state.hunger < 15) hpChange -= 0.8;  
        if (state.infection > 70) hpChange -= 0.6;
        if (state.infection > 90) hpChange -= 1.2;
        if (state.mood < 15) hpChange -= 0.5;
        if (state.activity < 10) hpChange -= 0.3;

        // –ë–û–ù–£–°–´
        if (state.mood > 90 && state.infection < 30) {
            hpChange += 0.4; 
        }

        if (hpChange < 0) {
            state.hp = Math.max(0, state.hp + (hpChange * factor));
        } else if (hpChange > 0) {
            state.hp = Math.min(100, state.hp + hpChange);
        }

        if (state.hp <= 0) {
            state.isDead = true;
            state.hp = 0;
            const exactDeathTime = (state.lastUpdate || now) + (i * 15000);
            state.timeOfDeath = exactDeathTime;
            const d = new Date(exactDeathTime);
            const deathDateStr = `${d.getDate().toString().padStart(2,'0')}.${(d.getMonth()+1).toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;

            state.logs.unshift({ 
                text: `üíÄ ${deathDateStr} - –ó–û–ú–ë–ò –ü–û–ì–ò–ë! (–≤ –≤–∞—à–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ).`, 
                cssClass: 'death-message' 
            });
            break; 
        }
    } // –ö–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ for

    state.lastUpdate = now;
    render();
    await API.set(state);
isSyncing = false;
}

// –§–£–ù–ö–¶–ò–Ø –í–û–°–ö–†–ï–®–ï–ù–ò–Ø (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –∞–¥–º–∏–Ω-—Å–∫—Ä–∏–ø—Ç–æ–º)
async function resurrect() {
    const remote = await API.get();
    if (remote) state = remote;

    state.isDead = false;
    state.hp = 80;      
    state.hunger = 70;
    state.mood = 70;
    state.activity = 70;
    state.infection = 5;
    state.createdAt = Date.now(); // –°–±—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ (–Ω–æ–≤—ã–π —Ü–∏–∫–ª)
    state.actions = {}; // –û–ë–ù–£–õ–ï–ù–ò–ï –î–ï–ô–°–¢–í–ò–ô: —Ç–µ–ø–µ—Ä—å —É –≤—Å–µ—Ö —Å–Ω–æ–≤–∞ 9/9
    state.timeOfDeath = null;
    
    state.logs.unshift({ 
        text: `‚ö° ${getFullLogDate()} - –í–û–°–ö–†–ï–®–ï–ù–ò–ï: –ó–æ–º–±–∏ —Å–Ω–æ–≤–∞ –≤ —Å—Ç—Ä–æ—é! –õ–∏–º–∏—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.`, 
        cssClass: 'admin-message' 
    });

state.lastUpdate = Date.now();
    render();
    await API.set(state);
    isSyncing = false; // –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞
}

function render() {
    if (!state) return;
    
    const now = getMoscowNow();
    
    // –¢–ê–ô–ú–ï–† –°–ë–†–û–°–ê
    if (state.isDead) {
        document.getElementById('actionsTimer').textContent = `–î–æ —Å–±—Ä–æ—Å–∞: 00:00:00`;
    } else {
        const midnight = new Date(now); midnight.setHours(24, 0, 0, 0);
        const diffT = midnight - now;
        document.getElementById('actionsTimer').textContent = `–î–æ —Å–±—Ä–æ—Å–∞: ${Math.floor(diffT/3600000).toString().padStart(2,'0')}:${Math.floor((diffT%3600000)/60000).toString().padStart(2,'0')}:${Math.floor((diffT%60000)/1000).toString().padStart(2,'0')}`;
    }
    
    ['hp', 'hunger', 'mood', 'activity', 'infection'].forEach(s => {
        const val = Math.round(state[s]);
        document.getElementById(`${s}Value`).textContent = val;
        document.getElementById(s).style.width = val + '%';
    });

    // –í–†–ï–ú–Ø –ñ–ò–ó–ù–ò (–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏)
    const endTime = state.isDead ? (state.timeOfDeath || state.lastUpdate) : Date.now();
    const deathTime = endTime - state.createdAt;
    const days = Math.floor(deathTime / 86400000);
    const hours = Math.floor((deathTime % 86400000) / 3600000);
    document.getElementById('aliveInfo').textContent = `${days} –¥., ${hours} —á.`;
    
    document.getElementById('rating').innerHTML = Object.entries(state.rating || {}).sort((a,b) => b[1]-a[1]).slice(0, 5).map(([n, s], i) => `<div class="rating-item"><span>${i+1}. ${n}</span><span style="color:#008080">${s}</span></div>`).join('');
    document.getElementById('logs').innerHTML = state.logs.map(l => `<div class="${l.cssClass}">${l.text}</div>`).join('');

    const today = getMoscowDateStr();
    const used = state.actions[USER]?.[today] || 0;
    const bonus = parseInt(state.bonuses?.[USER] || 0); 
    const leftActions = state.isDead ? 0 : Math.max(0, MAX_ACTIONS - used);
    
    // –ï—Å–ª–∏ –º–µ—Ä—Ç–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 0, –µ—Å–ª–∏ –∂–∏–≤ - –æ—Å—Ç–∞—Ç–æ–∫
    document.getElementById('actionsCounter').textContent = state.isDead ? `0/9` : `${leftActions}/9`;
    document.getElementById('bonusActions').textContent = ` ${bonus}`;
    
    // –ë–õ–û–ö–ò–†–û–í–ö–ê –ö–ù–û–ü–û–ö
    document.querySelectorAll('.action-btn').forEach(b => {
        b.disabled = state.isDead || (leftActions <= 0 && bonus <= 0);
    });

    if (!isAnimating) {
        ['zombieImage', 'happyGif', 'angryGif', 'sadImage', 'deadZombieImage'].forEach(id => document.getElementById(id).style.display = 'none');
        if (state.isDead) {
            document.getElementById('deadZombieImage').style.display = 'block';
        } else if (state.hp < 25) {
            document.getElementById('sadImage').style.display = 'block';
        } else {
            document.getElementById('zombieImage').style.display = 'block';
        }
    }
}

async function doAction(type) {
    if (state.isDead || isAnimating || isSyncing) return;
    isSyncing = true; 

    // 1. –ü–ï–†–ï–î –¥–µ–π—Å—Ç–≤–∏–µ–º –≤—Å–µ–≥–¥–∞ –±–µ—Ä–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
    const remote = await API.get();
    if (remote) state = remote;
    if (state.isDead) { render(); isSyncing = false; return; }

    const today = getMoscowDateStr();
    if (!state.actions[USER]) state.actions[USER] = {};
    if (!state.bonuses) state.bonuses = {};
    
    let usedToday = state.actions[USER][today] || 0;
    let bonus = parseInt(state.bonuses[USER] || 0);

    if (usedToday < MAX_ACTIONS) {
        usedToday++;
        state.actions[USER][today] = usedToday;
    } else if (bonus > 0) {
        bonus--;
        state.bonuses[USER] = bonus;
    } else { isSyncing = false; return; }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è...
    state.rating[USER] = (state.rating[USER] || 0) + 1;
    const up = (s, v) => state[s] = Math.min(100, state[s] + v);
    const down = (s, v) => state[s] = Math.max(0, state[s] - v);

    let actName = "";
    if (type === 'feed') { up('hunger', 30); down('activity', 5); actName = "–ø–æ–∫–æ—Ä–º–∏–ª –ó–æ–º–±–∏"; showEmotion('happy'); }
    if (type === 'play') { up('mood', 25); up('infection', 2); down('activity', 5); actName = "—Ä–∞–∑–≤–ª–µ–∫ –ó–æ–º–±–∏"; showEmotion('happy'); }
    if (type === 'heal') { up('hp', 15); down('infection', 40); actName = "–ø–æ–ª–µ—á–∏–ª –ó–æ–º–±–∏"; showEmotion('happy'); }
    if (type === 'energize') { up('activity', 35); down('mood', 10); actName = "–≤–∑–±–æ–¥—Ä–∏–ª –ó–æ–º–±–∏"; showEmotion('happy'); }
    if (type === 'sabotage') { up('infection', 15); down('mood', 10); actName = "—Å–æ–≤–µ—Ä—à–∏–ª —Å–∞–±–æ—Ç–∞–∂"; showEmotion('angry'); }

    state.logs.unshift({ 
        text: `${getFullLogDate()} - ${USER} ${actName}.`, 
        cssClass: type === 'sabotage' ? 'death-message' : '' 
    });
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ª–æ–≥, —á—Ç–æ–±—ã –æ–Ω –Ω–µ —Ä–∞–∑–¥—É–≤–∞–ª —Ñ–∞–π–ª (–∏–∑-–∑–∞ —ç—Ç–æ–≥–æ —Ç–æ–∂–µ –±—ã–≤–∞—é—Ç –ª–∞–≥–∏)
    state.logs = state.logs.slice(0, 40);
    state.lastUpdate = Date.now();

    render();
    await API.set(state); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
    isSyncing = false; 
}

function showEmotion(type) {
    if (state.isDead) return;
    isAnimating = true;
    const indicator = document.getElementById('emotionIndicator');
    ['zombieImage', 'happyGif', 'angryGif', 'sadImage', 'deadZombieImage'].forEach(id => document.getElementById(id).style.display = 'none');
    
    if (type === 'happy') { 
        document.getElementById('happyGif').style.display = 'block'; 
        indicator.textContent = '–ó–æ–º–±–∏ –¥–æ–≤–æ–ª–µ–Ω!'; 
    } else if (type === 'angry') { 
        document.getElementById('angryGif').style.display = 'block'; 
        indicator.textContent = '–ó–æ–º–±–∏ –≤ —è—Ä–æ—Å—Ç–∏!'; 
    }
    
    indicator.classList.add('show');
    setTimeout(() => { 
        indicator.classList.remove('show'); 
        isAnimating = false; 
        render(); 
    }, 3000);
}

async function autoSync() {
    const remote = await API.get();
    if (remote && JSON.stringify(remote) !== JSON.stringify(state)) { 
        state = remote; 
        render(); 
    }
}

async function init() {
    state = await API.get();
    if (!state) { 
        state = { 
            hp: 75, hunger: 65, mood: 60, activity: 55, infection: 35, 
            createdAt: Date.now(), lastUpdate: Date.now(), logs: [], 
            rating: {}, actions: {}, bonuses: {}, isDead: false 
        };
        await API.set(state);
    }
    document.getElementById('loadingOverlay').style.display = 'none';
    render();
    
    // –û–°–¢–ê–í–õ–Ø–ï–ú –¢–û–õ–¨–ö–û –≠–¢–û:
    setInterval(render, 1000);    // –î–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ —Ç–∞–π–º–µ—Ä–æ–≤
    setInterval(gameTick, 20000); // –†–∞–∑ –≤ 20 —Å–µ–∫—É–Ω–¥: —Å—á–∏—Ç–∞–µ–º –∏–∑–Ω–æ—Å –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–º—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
}
init();

function toggleInfoModal() {
    const modal = document.getElementById('infoModal');
    if (modal.style.display === 'flex') {
        modal.style.display = 'none';
    } else {
        modal.style.display = 'flex';
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
window.onclick = function(event) {
    const modal = document.getElementById('infoModal');
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
</script>
